---
title: "SeaScape_Timelines"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message = FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)

library(scales)

library(akima)
#library(asbio)
#library(tmap)         # raster + vector layers
#library(raster)       # Main raster library
#library(tidyverse)    # our old friend
#library(sf)           # to work with simple features data
#library(mapview)
library(openxlsx)
library(class)
library(RANN)
library("survival")
library("Hmisc")

library(MARSS)
library(utils)


#install.packages("survival")

library(lattice)
#install.packages("latticeExtra")


library(survival)
library(Hmisc)
library(lubridate)
library(CHNOSZ)
library(data.table)
#install.packages("installr")
#library(installr)
```

Creating useful custom functions
```{r}
left_join0<- function(x, y, fill = 0){
  z <- left_join(x, y)
  tmp <- setdiff(names(z), names(x))
  z <- replace_na(z, setNames(as.list(rep(fill, length(tmp))), tmp))
  z
}
```

## Importing and Tidying GC Image Data
Background: GC image pre-processing
- All images must be RI configured and searched against 1) a custom library of internal standard compounds 2) a custom library of field blank compounds 3) one or more custom libraries of template compounds to be traced over campaign.  Libraries need not be compiled into one and can remain separated by source file. 
- Note: manually checking for appropriate internal standard assignments strongly advised

Required files:
- Blob table summary.  See example for formatting; match exactly to avoid bugs. Note: if GCxGC file name convention differs from that in example blob table summary, adjust the date and file parsing code accordingly
- Folder with all blob tables to be parsed
- all blob tables from pre-processed GC image files in csv format
```{r timeline_import, message=FALSE, warning=FALSE}
bt_sum_bloom3 <- read_csv("Read_Files/Blob_table_summary_CAICESample.csv") %>% 
  filter(Bloom == 3)

bt_sum_bloom <- read_csv("Read_Files/Blob_table_summary_CAICESample.csv") %>% 
  filter(Category == "Sample")

bt_sum_bloom3 <- bt_sum_bloom3 %>% mutate(r_date =    mdy_hm(SS_startdate)) %>% 
  mutate(run_date = as.Date(gsub("GCxGC_","",File_num), "%Y%m%d"))

make_file_name <- function(date_string) {
  file_start <- "Read_Files/CAICE_blobtables/"
  file_end <- ".h5_img01_Blob_Table.csv"
  full_name <- paste(file_start,date_string,file_end, sep = "")
  return(full_name)
  
}

read_bt_files <- function(fi_name_short) {
  
  fi_name <- make_file_name(fi_name_short)
  temp_bt <<- read_csv(file = fi_name)
  temp_bt <- temp_bt %>% mutate(File_num = fi_name_short)
  temp_bt <<- temp_bt
  return(temp_bt)
}

make_massive_table <- function(summary_table){
 
  M <- read_bt_files(as.character(summary_table$File_num[1]))

  for(i in 2:length(summary_table$File_num)){
    t <- read_bt_files(as.character(summary_table$File_num[i]))
    Mnew <- rbind(M, t)
    M <- Mnew
    print(i)
  }
  M_t <<- M
}

make_massive_table(bt_sum_bloom3)


M_t_full3 <- M_t %>% 
  left_join(bt_sum_bloom3, by = "File_num") %>% 
  mutate(Punch_t_norm_vol = Volume/Punch_num_sample_time_norm)

names(M_t_full3) <- make.names(names(M_t_full3),unique = TRUE) 

make_massive_table(bt_sum_bloom)


M_t_full <- M_t %>% 
  left_join(bt_sum_bloom, by = "File_num") %>% 
  mutate(Punch_t_norm_vol = Volume/Punch_num_sample_time_norm)

names(M_t_full) <- make.names(names(M_t_full),unique = TRUE) 

btz1 <- M_t_full3 %>% 
  filter(Compound.Name == "20200803_1535_blob_958_")
# its here

```

condensing to unique points

```{r, message=FALSE, warning=FALSE}
Match_factor_floor <- 750
Reverse_match_factor_floor <- 100
LRI_diff_floor <- 6




fb_match_factor_floor <- 600
fb_reverse_match_factor_floor <- 100
IS_lib_name <- "caice_ssi"
lib_remove_1 <- "caice_ssa_0805_0612"
lib_remove_2 <- "caice_ssa_0803_1728"
lib_remove_3 <- "caice_ssa_0803_oil_1728"
lib_remove_4 <- "amzi0503_b"
#FB_lib_name <- "amz_fb_trimmed_esrem"

rt2_floor <- .2 # note: check on this, but for purposes of indexing retention times in 2d this is important

# creating a column of the differences in linear retention indecies so that poor matches can be screened out
M_t_LRI <- M_t_full3 %>% mutate(LRI_diff = abs(Library.RI-LRI.I)) %>% 
  mutate(LRI_diff = replace_na(LRI_diff, -999))

btz2 <- M_t_LRI %>% 
  filter(Compound.Name == "20200803_1535_blob_958_")
# its here too

# getting rid of things that should be removed
remove_match <- M_t_LRI %>% 
  filter(Library.Name == lib_remove_1 | Library.Name == lib_remove_2 | Library.Name == lib_remove_3 | Library.Name == lib_remove_4)

btz3 <- remove_match %>% 
  filter(Compound.Name == "20200803_1535_blob_958_")
# not here, good

# identifying the internal standard
IS_goodmatch <- M_t_LRI %>% 
  filter(Library.Name == IS_lib_name | Library.Name == "-") %>% 
  filter(LRI_diff < LRI_diff_floor) %>% 
  filter(Library.Match.Factor > Match_factor_floor| Description== "match")  

# FB_goodmatch <- M_t_LRI %>% 
#   filter(Library.Name == FB_lib_name) %>% 
#   filter(LRI_diff < LRI_diff_floor) %>% 
#   filter(Library.Match.Factor > fb_match_factor_floor)
# 
# FB_okmatch <- M_t_LRI %>% 
#   filter(Library.Name == FB_lib_name) %>% 
#   filter(Library.Match.Factor> fb_match_factor_floor-100) %>% 
#   anti_join(FB_goodmatch)
  
IS_okmatch <- M_t_LRI %>% 
  filter(Library.Name == IS_lib_name | Library.Name == "-") %>%
  filter(Library.Match.Factor > Match_factor_floor-100)  %>% 
  anti_join(IS_goodmatch)

small_poorlymatched <- M_t_LRI %>% 
  filter(Library.Match.Factor < Match_factor_floor) %>% 
  filter(Volume < 200)

btz4 <- small_poorlymatched %>% 
  filter(Compound.Name == "20200803_1535_blob_958_")
# 33/70 in here, makes sense

M_t_all_analytes <- M_t_LRI %>% 
  #anti_join(FB_goodmatch) %>% 
  anti_join(IS_goodmatch) %>% 
  #anti_join(FB_okmatch) %>% 
  anti_join(IS_okmatch) %>% 
  anti_join(remove_match) %>% 
  anti_join(small_poorlymatched) %>% 
  filter(LRI.I > 1200) 

btz1 <- M_t_all_analytes %>% 
  filter(Compound.Name == "20200803_1535_blob_958_")

## Getting rid of things that existed and were well matched in the tap water blank



tap_water_blank <- read_csv("Read_Files/CAICE_tapwater_ssasearched.csv")

names(tap_water_blank) <- make.names(names(tap_water_blank),unique = TRUE) 

tap_water_blank_matches <- tap_water_blank %>% 
  filter(Library.Match.Factor > 750) %>% 
  filter(Library.Name != "caice_ssi") %>% 
  filter(Volume > 10000) %>% 
  dplyr::select(Compound.Name) %>% 
  mutate(in_background = 1)

M_t_all_analytes <- M_t_all_analytes %>% 
  left_join(tap_water_blank_matches) %>% 
  filter(is.na(in_background))

  
M_t_analyte_unique <- M_t_all_analytes %>% 
  arrange((r_date)) %>% 
  filter(Library.Name != IS_lib_name) %>% 
  filter(LRI_diff < LRI_diff_floor) %>% 
  filter(Library.Match.Factor > Match_factor_floor | Description == "match") %>% 
  #filter(Library.Reverse.Match.Factor > Reverse_match_factor_floor) %>% 
  arrange(desc(Volume)) %>% 
  arrange(Compound.Name) %>% 
  arrange(r_date) %>% 
  distinct(Compound.Name, r_date, .keep_all = TRUE) 




```
Important to note: the blob names are messed up for the template from 0805- still listed as from 0803


Tracing Library Performance
```{r}

# tracking the mass of all of the analytes before bad matches are screened out for later analysis of library performance
M_t_all_analytes_volcount <- M_t_all_analytes %>% 
  group_by(File_num) %>% 
  summarise(rawvol = sum(Volume))

# tracking the number of all analutes in
M_t_all_analytes_ncount <- M_t_all_analytes %>% 
  count(File_num) %>% 
  rename(total_num_analyte = n)

M_t_match_analytes_volcount <- M_t_analyte_unique %>% 
  group_by(File_num) %>% 
  summarise(rawvol_match = sum(Volume))

M_t_match_analytes_ncount <- M_t_analyte_unique %>% 
  count(File_num) %>% 
  rename(total_num_analyte_match = n)

M_t_analyte_summary <- M_t_all_analytes_volcount %>% 
  left_join(M_t_all_analytes_ncount) %>% 
  left_join(M_t_match_analytes_volcount) %>% 
  left_join(M_t_match_analytes_ncount) %>% 
  mutate(perct_nfound = (total_num_analyte_match/total_num_analyte)*100) %>% 
  mutate(perct_volfound = (rawvol_match/rawvol)*100)

compound_pop <- M_t_analyte_unique %>% 
  count(Compound.Name) %>% 
  rename(comp.n = n) %>% 
  mutate(pct_of_samp = (comp.n/max(comp.n)*100))

M_t_analyte_count <- M_t_all_analytes %>% 
  count(File_num) %>%
  rename(total_num_analyte = n)
# 
# # counting the number of unique analytes in each image
num_analyte_unique <- M_t_analyte_unique %>%
  count(File_num) %>%
  rename(unique.analyte = n)

# counting the number based percent of compounds being traced in all 
perct_comps_traced <- num_analyte_unique %>% 
   left_join(M_t_analyte_count) %>% 
   mutate(pct_found = unique.analyte/total_num_analyte)
# 

summary(perct_comps_traced$pct_found)


M_t_analyte_unique <- M_t_analyte_unique %>% left_join(num_analyte_unique)

compound_pop <- M_t_analyte_unique %>% 
  count(Compound.Name) %>% 
  rename(comp.n = n) %>% 
  mutate(pct_of_samp = (comp.n/max(comp.n)*100))

table(compound_pop$comp.n)

hist(compound_pop$pct_of_samp, 
     main = paste("Histogram of", nrow(compound_pop), "Traced Compounds\nOver Seascape Bloom 3"),
     xlab = "Percent Occurence Above Detection Limits",
     col = "grey")

SeaScape_sample_cumcum <- M_t_analyte_unique %>% 
  group_by(File_num) %>% 
  summarise(File_vol = sum(Volume))


M_t_analyte_unique <- M_t_analyte_unique %>% 
  left_join(compound_pop) %>% 
  left_join(SeaScape_sample_cumcum) %>% 
  mutate(Volume_Fraction = Volume/File_vol)


M_t_analyte_unique %>% 
  mutate(char_comp_n = as.integer(round(pct_of_samp, 0))) %>% 
  group_by(char_comp_n) %>% 
  summarise(avg_vol_byn = mean(Volume)) %>% 
  ggplot(aes(x = char_comp_n, y = avg_vol_byn)) +
  geom_col()+
  labs(title = "Average Blob Volume by Library Match Frequency")+
  xlab("Percent of Samples with Positive Library Match")+
  ylab("Average Blob Volume")

```

```{r fig.width=2, fig.height=3, warning = FALSE}


M_t_analyte_summary %>% 
  ggplot(aes(y = perct_nfound))+
  geom_boxplot(fill = "pink") + 
  theme_bw()+
  ylab("Percent of Analytes Assigned to \nLibrary Match")

M_t_analyte_summary %>% 
  ggplot(aes(y = perct_volfound))+
  geom_boxplot(fill = "pink") + 
  theme_bw()+
  ylab("Percent of Analyte Volume Assigned to \nLibrary Match")

summary(M_t_analyte_summary$perct_volfound)

#weighted average of distances
#leave one out cross validation

#kriging- from geography
#GAM to build 2d surface 
# try predict with GAM or loess surface, 
# link function for GAM
# could use a moving window 
```



Tracking appearance of new compounds
```{r}

unique_tracing <- M_t_analyte_unique %>% 
  arrange(r_date)

unique_tag <- 
  unique_tracing %>% 
  filter(File_num == bt_sum_bloom3$File_num[1]) %>% 
  mutate(is_unique_prior = NA) %>% 
  dplyr::select(Compound.Name, File_num, is_unique_prior)


for(i in 2:nrow(bt_sum_bloom3)){
  
  
  
  previous_file_i <- bt_sum_bloom3$File_num[i-1]
  file_i <- bt_sum_bloom3$File_num[i]
  
  prev_compounds <- unique_tracing %>% 
    filter(File_num == previous_file_i) %>% 
    mutate(is_unique_prior = FALSE) %>% 
    dplyr::select(Compound.Name, is_unique_prior)
  
  compounds_i <- unique_tracing %>% 
    filter(File_num== file_i)
  
  
  unique_tag_t <- compounds_i %>% 
    left_join(prev_compounds, by = "Compound.Name") %>% 
    dplyr::select(Compound.Name, File_num, is_unique_prior)
  
  unique_tag <- rbind(unique_tag, unique_tag_t)
    
  
}

unique_tracing_c <- unique_tracing %>% 
  left_join(unique_tag, by = c("Compound.Name", "File_num")) %>% 
  mutate(unique_log = is.na(is_unique_prior)) %>% 
  mutate(unique_vol = unique_log * Volume/(Punch_num_sample_time_norm)) 


avg_unique = sum(unique_tracing_c$unique_vol)/sum(unique_tracing_c$Volume)

```

more unique tracing

```{r}
unique_tracing_c %>% 
  #filter(IOP == 2) %>% 
  mutate(ones = 1) %>% 
  ggplot(aes(fill = unique_log, y = ones, x = r_date))+
  geom_bar(position = "stack", stat = "identity")+
  ylab("Analyte Count")




unique_tracing_c %>% 
  #filter(IOP == 2) %>% 
  mutate(ones = 1) %>% 
  ggplot(aes(fill = unique_log, y = Punch_t_norm_vol, x = r_date))+
  geom_bar(position = "stack", stat = "identity")+
  ylab("Analyte Raw Volume")+
  xlab("Dry Season GoAmazon Date")+
  scale_fill_manual(name = "Unique Compared\n to Previous Sample", values=c("blue", "green"))+
  theme(axis.text.x = element_text(size=14), axis.text.y = element_text(size=14), axis.text=element_text(size=12),
        axis.title=element_text(size=14))


  
  
```
Adding in cumsum and pct found to analyte unique for raw timelines
```{r pressure, importing chemical info}

compiled_comp_info <- read_csv("Read_Files/Compiled_Compoundinfo_Blobtable_SS.csv")

names(compiled_comp_info) <- make.names(names(compiled_comp_info),unique = TRUE)

compiled_comp_info.findable <- compiled_comp_info %>% 
  filter(Library.Match.Factor_NISTmain> 800) %>% 
  mutate(Identifiable = TRUE) %>% 
  dplyr::select(Compound.Name, Identifiable)

#id.tags <- data.frame("Identifiable"= c(TRUE, NA), ID)

compiled_comp_info <- compiled_comp_info %>% 
  left_join(compiled_comp_info.findable) %>% 
  mutate(tic = 1)

compiled_comp_info %>% 
  ggplot(aes(x = "", y = tic, fill = Identifiable)) + 
  geom_col()+
  coord_polar("y", start = 0)+
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "",
       x = NULL,
       y = NULL) + 
  ggtitle("765 Novel and Identifiable\nSubmicron SSA Compounds- SeaScape")

```


```{r}
SeaScape_cumsum_raw <- M_t_analyte_unique %>% 
  mutate(tic = 1) %>% 
  group_by(Compound.Name) %>% 
  summarise(raw_cumsum = sum(Punch_t_norm_vol), num_obs = sum(tic)) %>% 
  mutate(pct_obs = num_obs/nrow(bt_sum_bloom3)) %>% 
  arrange(desc(raw_cumsum))





M_t_analyte_unique_info <- M_t_analyte_unique %>% 
  left_join(SeaScape_cumsum_raw, by = "Compound.Name") %>% 
  left_join(compiled_comp_info, by = "Compound.Name") %>% 
  left_join(compiled_comp_info.findable, by = "Compound.Name")

for(i in 1:nrow(compiled_comp_info.findable)){
  findable_c <- compiled_comp_info$Compound.Name[i]
  
  f1 <- M_t_analyte_unique_info %>% 
    filter(Compound.Name == findable_c) %>% 
    ggplot(aes(x = r_date, y = Punch_t_norm_vol, color = Compound.Name_NISTmain))+
    geom_line()
  
  print(f1)
  
  
  
  
}


# for(i in 1:100){
#   big_c <- SeaScape_cumsum_raw$Compound.Name[i]
#   
#   f2 <- M_t_analyte_unique_info %>% 
#     filter(Compound.Name == big_c) %>% 
#     ggplot(aes(x = r_date, y = Volume_Fraction, color = Compound.Name_NISTmain))+
#     geom_line()+
#     geom_point(aes(x = r_date, y = Volume_Fraction, shape = T_O_D, fill = Library.Match.Factor_NISTmain))
#   
#   print(f2)
#   
#   
#   
#   
# }

# for(i in 1:100){
#   big_c <- SeaScape_cumsum_raw$Compound.Name[i]
#   
#   f3 <- M_t_analyte_unique_info %>% 
#     filter(Compound.Name == big_c) %>% 
#     ggplot(aes(x = r_date, y = Punch_t_norm_vol, color = Compound.Name_NISTmain))+
#     geom_line()+
#     geom_point(aes(x = r_date, y = Punch_t_norm_vol, shape = T_O_D, fill = Library.Match.Factor_NISTmain))
#   
#   print(f3)
#   
#   
# }



```


Internal Standard Mapping

```{r IS_mapping1}
# note: unlike sample analytes, internal standard compounds are frequently split vertically into multiple blobs because of the high volume.  In order to account for this, I am summing all blobs together that meet the high match criteria and are very close in the first dimension.
IS_unique <- IS_goodmatch %>% 
  group_by(Compound.Name, File_num) %>% 
  summarise(Volume_tot = sum(Volume)) %>% 
  filter(Compound.Name != "glucose-13C6") %>% 
  filter(Compound.Name != "dC14") 

fixing <- data.frame(table(IS_unique$Compound.Name)) %>% 
  mutate(Compound.Name = Var1)

IS_tofix <- IS_unique %>% 
  left_join(fixing) %>% 
  filter(Freq < 37) %>% 
  left_join(bt_sum_bloom3, by = "File_num")

IS_unique_c <- IS_unique %>% 
  mutate(tic = 1) %>% 
  group_by(File_num) %>% 
  summarise(ticsum = sum(tic))

c<- data.frame(table(IS_unique$Compound.Name))

# note: this is not knitting, not sure why but did temporary work around
# IS_positions <- IS_goodmatch %>% 
#   filter(Compound.Name != "glucose-13C6") %>% 
#   filter(Compound.Name != "dC14") %>% 
#   group_by(Compound.Name, File_num) %>% 
#   #summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec.-rt2_floor))
#   summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec. - rt2_floor))
# 
# IS_positions_knit <- write.csv(IS_positions, "IS.pos.knit.csv2")

IS_positions <- read.csv("Read_Files/IS.pos.knit.csv") %>% 
  dplyr::select(-X)
  

IS_avg_vols_toadd <- IS_unique %>% 
  group_by(Compound.Name) %>% 
  summarise(IS_avgvol = mean(Volume_tot), IS_medvol = median(Volume_tot)) %>% 
  left_join(IS_unique) %>% 
  mutate(IS_mean_norm = Volume_tot / IS_avgvol) %>%
  mutate(IS_med_norm = Volume_tot / IS_medvol) %>% 
  dplyr::select(Compound.Name, File_num, IS_mean_norm)

IS_unique_pos <- IS_unique %>% 
  left_join(IS_positions) %>% 
  left_join(IS_avg_vols_toadd)



IS_test1 <- IS_unique_pos %>% 
  filter(File_num == "GCxGC_20200803_1001")

IS_1_vol <- IS_test1$Volume_tot
RI1 <- IS_test1$LRI_avg
RI2 <- IS_test1$RI2

# IS_1_pos <- IS_test1 %>% 
#   ungroup() %>% 
#   dplyr::select("LRI_avg", "RI2")
IS_positions_202008061332 <- read.csv("Read_Files/GCxGC_20200806_1332.h5_img01_IS_selected_positions_Blob_Table.csv")
IS_rt2 <- IS_positions_202008061332 %>% 
  dplyr::select(Compound.Name, Retention.II..sec.)

IS_positions <- IS_goodmatch %>% 
  filter(Compound.Name != "glucose-13C6") %>% 
  filter(Compound.Name != "dC14") %>% 
  group_by(Compound.Name, File_num) %>% 
  #summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec.-rt2_floor))
  summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec. - rt2_floor))


IS_positions_avg <- IS_positions %>% 
  group_by(Compound.Name) %>% 
  summarise(LRI_avg_all = mean(LRI_avg, na.rm = TRUE), Retention.II..sec. = mean(RI2, na.rm = TRUE)) 


write.csv(IS_positions_avg, "Write_Files/IS_positions_avg.csv")


IS_avg_vols <- IS_unique %>% 
  group_by(Compound.Name) %>% 
  summarise(IS_avgvol = mean(Volume_tot), IS_medvol = median(Volume_tot)) %>% 
  left_join(IS_unique) %>% 
  mutate(IS_mean_norm = Volume_tot / IS_avgvol) %>%
  mutate(IS_med_norm = Volume_tot / IS_medvol) %>% 
  left_join(bt_sum_bloom3)

IS_cat <- read.csv("Read_Files/IS_withcat.csv")
IS_cat <- IS_cat %>% 
  dplyr::select(-X)

IS_avg_vols <- IS_avg_vols %>% 
  left_join(IS_cat)
  

IS_just_one_IS <- IS_avg_vols %>% 
  filter(Compound.Name == "dC24") %>% 
  dplyr::select(File_num, dalk_norm=IS_mean_norm) 

IS_stability <- IS_avg_vols %>% 
  left_join(IS_just_one_IS) %>% 
  left_join(IS_positions_avg)

IS_stability %>% 
  ggplot(aes(x = dalk_norm, y = IS_mean_norm, color = F_group_cat))+
  geom_point()+
  ylim(0, 2) +
  xlim(0,2)
  



IS_avg_vols %>% ggplot(aes(x = r_date, y = IS_med_norm, color = Compound.Name)) +
  geom_point()
  

IS_avg_vols %>% ggplot(aes(x = r_date, y = Volume_tot, color = Compound.Name)) +
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = IS_mean_norm, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = Volume_tot, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = IS_mean_norm, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = Volume_tot, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = IS_mean_norm, color = F_group_cat))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = Volume_tot, color = F_group_cat))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = IS_mean_norm, color = F_group_cat))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = Volume_tot, color = F_group_cat))+
  geom_point()
```
Conclusion: Normalizing by the nearest mean or median normalized internal standard volume is most appropriate, as the responses of different internal standard on a raw volume basis are a function of chemical characteristics rather than purely instrument response (itself a function of matrix effects and instrument condition, which cannot be effectively deconvoluted).  As the quantification model takes into account chemical characteristics through a machine learning model trained on the mass spectrum, normalization by raw internal standard volume introduces covarying factors.

```{r IS_mapping2}
LRI_weight = 10
LRII_weight = 1

LRI1_avg = mean(IS_positions_avg$LRI_avg_all, na.rm = TRUE)
LRI2_avg = mean(IS_positions_avg$Retention.II..sec.)

IS_positions_avg <- IS_positions_avg %>% 
  mutate(relative_LRI = (LRI_avg_all/LRI1_avg)*LRI_weight) %>% 
  mutate(relative_LRI2 = (Retention.II..sec./LRI2_avg)*LRII_weight)

write.csv(IS_positions_avg, "Write_Files/IS_positions_avg_rel.csv")

Analyte_positions_trial <- M_t_analyte_unique %>% 
  group_by(Compound.Name, File_num) %>% 
  summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec. - rt2_floor))

# note filtering out three small blobs outside of RI window

Analyte_positions <- M_t_analyte_unique %>% 
  filter(!is.na(LRI.I)) %>% 
  group_by(Compound.Name) %>% 
  summarise(LRI_avg = mean(LRI.I, na.rm = TRUE), RI2 = (mean(Retention.II..sec.) - rt2_floor))

Analyte_positions <- Analyte_positions %>% 
  mutate(relative_LRI = (LRI_avg/LRI1_avg)*LRI_weight) %>% 
  mutate(relative_LRI2 = (RI2/LRI2_avg)*LRII_weight)

# checking to make sure that the ranges match up, eg back end checking that same norm method used on moth IS and analyte positions
summary(IS_positions_avg$relative_LRI)
summary(Analyte_positions$relative_LRI)
summary(IS_positions_avg$relative_LRI2)
summary(Analyte_positions$relative_LRI2)

Analyte_pos_short <- Analyte_positions %>% 
  dplyr::select(relative_LRI, relative_LRI2)

IS_pos_short <- IS_positions_avg %>% 
  dplyr::select(relative_LRI, relative_LRI2)

#knn(IS_pos_short, Analyte_pos_short, cl=IS_pos_short$Compound.Name, k=1, l=0)

#Old method, only using 1 nearest
#testnn <- nn2(IS_pos_short, query = Analyte_pos_short, treetype = "kd", searchtype = "standard", k=1)

# note 1.19 is the min radius at which every compound has at least one nearest
testnn <- nn2(IS_pos_short, query = Analyte_pos_short, treetype = "kd", searchtype = "radius", k=3, radius = 3.9)


Analyte_IS_Index <- data.frame(testnn$nn.idx)
# old method only using 1 nearest
# Analyte_pos_ad <- data.frame(Compound.Name = Analyte_positions$Compound.Name, IS_index = Analyte_IS_Index)

Analyte_pos_ad <- data.frame(Compound.Name = Analyte_positions$Compound.Name, IS_index1 = Analyte_IS_Index$X1, IS_index2 = Analyte_IS_Index$X2, IS_index3 = Analyte_IS_Index$X3)

# old method with only 1 IS
# Analyte_with_IS <- Analyte_pos_ad %>% 
#   mutate(IS_appropriate = IS_positions_avg$Compound.Name[IS_index])

# Analyte_with_IS <- Analyte_pos_ad %>% 
#   mutate(IS_appropriate1 = IS_positions_avg$Compound.Name[IS_index1]) %>% 
#   mutate(IS_appropriate2 = IS_positions_avg$Compound.Name[IS_index2]) %>% 
#   mutate(IS_appropriate3 = IS_positions_avg$Compound.Name[IS_index3])

Analyte_with_IS <- Analyte_pos_ad %>% 
  mutate(IS_appropriate1 = NA) %>% 
  mutate(IS_appropriate2 = NA) %>% 
  mutate(IS_appropriate3 = NA)

for(i in 1:nrow(Analyte_with_IS)){
  t_isind_1 <- Analyte_with_IS$IS_index1[i]
  t_isind_2 <- Analyte_with_IS$IS_index2[i]
  t_isind_3 <- Analyte_with_IS$IS_index3[i]
  
  if(t_isind_1 > 0){
  t_isap_1 <- IS_positions_avg$Compound.Name[t_isind_1]
  }else{
    t_isap_1 <- NA
  }
  
  if(t_isind_2 > 0){
  t_isap_2 <- IS_positions_avg$Compound.Name[t_isind_2]
  }else{
    t_isap_2 <- NA
  }
  
  if(t_isind_3 > 0){
  t_isap_3 <- IS_positions_avg$Compound.Name[t_isind_3]
  }else{
    t_isap_3 <- NA
  }
  
  
  
  Analyte_with_IS$IS_appropriate1[i] <- t_isap_1
  Analyte_with_IS$IS_appropriate2[i] <- t_isap_2
  Analyte_with_IS$IS_appropriate3[i] <- t_isap_3
  
}

# Analyte_with_IS_positions <- Analyte_with_IS %>% 
#   left_join(Analyte_positions) %>% 
#   left_join(IS_positions_avg, by = c("IS_appropriate"= "Compound.Name"))

Analyte_with_IS_positions <- Analyte_with_IS %>% 
  left_join(Analyte_positions) %>% 
  left_join(IS_positions_avg, by = c("IS_appropriate1"= "Compound.Name")) %>% 
  left_join(IS_positions_avg, by = c("IS_appropriate2"= "Compound.Name")) %>% 
  left_join(IS_positions_avg, by = c("IS_appropriate3"= "Compound.Name"))

M_t_analyte_withIS <- M_t_analyte_unique %>% 
  left_join(Analyte_with_IS) %>% 
  mutate(IS_vol1= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm1= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_vol2= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm2= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_vol3= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm3= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_vol_dalk= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm_dalk= -999*(LRI.I/LRI.I))

# old- only 1 IS
# M_t_analyte_withIS <- M_t_analyte_unique %>% 
#   left_join(Analyte_with_IS) %>% 
#   mutate(IS_vol= -999*(LRI.I/LRI.I)) %>% 
#   mutate(IS_mean_norm= -999*(LRI.I/LRI.I)) 


# for(i in 1:nrow(M_t_analyte_withIS)){
#   
#   
#   IS_name = M_t_analyte_withIS$IS_appropriate[i]
#   File_num_t = M_t_analyte_withIS$File_num[i]
#   
#   IS_indicated <- IS_stability %>% 
#     filter(Compound.Name == IS_name) %>% 
#     filter(File_num == File_num_t)
#   
#   M_t_analyte_withIS$IS_vol[i] <-IS_indicated$Volume_tot[1]
#   M_t_analyte_withIS$IS_mean_norm[i] <-IS_indicated$IS_mean_norm[1]
#   
#   
# }

for(i in 1:nrow(M_t_analyte_withIS)){
  
  
  
  IS_name1 = M_t_analyte_withIS$IS_appropriate1[i]
  IS_name2 = M_t_analyte_withIS$IS_appropriate2[i]
  IS_name3 = M_t_analyte_withIS$IS_appropriate3[i]
  
  
  
  
  File_num_t = M_t_analyte_withIS$File_num[i]
  
  IS_indicated1 <- IS_stability %>% 
    filter(Compound.Name == IS_name1) %>% 
    filter(File_num == File_num_t)
  
  M_t_analyte_withIS$IS_vol1[i] <-IS_indicated1$Volume_tot[1]
  M_t_analyte_withIS$IS_mean_norm1[i] <-IS_indicated1$IS_mean_norm[1]
  
  IS_indicated2 <- IS_stability %>% 
    filter(Compound.Name == IS_name2) %>% 
    filter(File_num == File_num_t)
  
  M_t_analyte_withIS$IS_vol2[i] <-IS_indicated2$Volume_tot[1]
  M_t_analyte_withIS$IS_mean_norm2[i] <-IS_indicated2$IS_mean_norm[1]
  
  IS_indicated3 <- IS_stability %>% 
    filter(Compound.Name == IS_name3) %>% 
    filter(File_num == File_num_t)
  
  M_t_analyte_withIS$IS_vol3[i] <-IS_indicated3$Volume_tot[1]
  M_t_analyte_withIS$IS_mean_norm3[i] <-IS_indicated3$IS_mean_norm[1]
  
}

# 
# M_t_analyte_withIS <- M_t_analyte_withIS %>% 
#   mutate(vol_is_normnorm = Volume/IS_mean_norm) %>% 
#   mutate(vol_is_rawnorm = Volume/IS_vol)
#   

# note- this step is not working
# M_t_analyte_withIS <- M_t_analyte_withIS %>% 
#   mutate(IS_vol = mean(c(IS_vol1, IS_vol2, IS_vol3), na.rm = TRUE)) %>% 
#   mutate(IS_mean_norm = mean(c(IS_mean_norm1, IS_mean_norm2, IS_mean_norm3), na.rm = TRUE))

for(i in 1:nrow(M_t_analyte_withIS)){
  
  isvols_raw <- c(M_t_analyte_withIS$IS_vol1[i], M_t_analyte_withIS$IS_vol2[i], M_t_analyte_withIS$IS_vol3[i])
  
  M_t_analyte_withIS$IS_vol[i] = mean(isvols_raw, na.rm = TRUE)
  
  isvols_norm <- c(M_t_analyte_withIS$IS_mean_norm1[i], M_t_analyte_withIS$IS_mean_norm2[i], M_t_analyte_withIS$IS_mean_norm3[i])
  
  M_t_analyte_withIS$IS_mean_norm[i] = mean(isvols_norm, na.rm = TRUE)
  
}


M_t_analyte_withIS <- M_t_analyte_withIS %>% 
  mutate(vol_is_normnorm = Volume/IS_mean_norm) %>% 
  mutate(vol_is_rawnorm = Volume/IS_vol) %>%
  mutate(vol_is_normnorm_ptnorm = vol_is_normnorm/(Punch_num_sample_time_norm)) %>% 
  mutate(vol_is_rawnorm_ptnorm = vol_is_rawnorm/(Punch_num_sample_time_norm))


IS_problems <- M_t_analyte_withIS %>% 
  filter(is.na(IS_appropriate1))

File_norm_totorg <- M_t_analyte_withIS %>% 
  group_by(r_date) %>% 
  summarise(vol_normnorm_total = sum(vol_is_normnorm_ptnorm), vol_rawnorm_total = sum(vol_is_rawnorm_ptnorm))

File_norm_totorg %>% 
  ggplot(aes(x = r_date, y = vol_rawnorm_total))+
  geom_point()

File_norm_totorg %>% 
  ggplot(aes(x = r_date, y = vol_normnorm_total))+
  geom_point()

M_t_analyte_withIS <- M_t_analyte_withIS %>% 
  left_join(File_norm_totorg) %>% 
  mutate(vol_is_normnorm_ptnorm_totorgnorm = vol_is_normnorm_ptnorm/vol_normnorm_total)


```

# adding in quant factors, some modeled some real
```{r}
QF_o <- read_csv("Read_Files/Compiled_Compound_info_SeaScape.quant_EBF_3.csv")
tot_org_o <- read_csv("Read_Files/Davis_Total_org.csv") %>% 
  mutate(r_date = mdy_hm(Date))

QF_s <- QF_o %>% 
  dplyr::select(Compound.Name, Quant_Factor_final)


# now deterimining the appropriate OM:OC ratio from the average of the identifiable
# constituents in ES
ES_known_form_o <- read_csv("Read_Files/Known_Compound_Formulae.csv")

ES_known_form <- ES_known_form_o %>% 
  dplyr::rename(ChemFormula = Formula_Underivitized_forMod) %>% 
  dplyr::mutate(Cnum = 0) %>% 
  dplyr::mutate(Hnum = 0) %>% 
  dplyr::mutate(Onum = 0) %>% 
  dplyr::mutate(Nnum = 0) %>% 
  dplyr::mutate(Snum = 0)

Element <- c("C", "H", "O", "N", "S")
d.e <- data.frame(Element = Element)


for(i in 1:nrow(ES_known_form)){
  
  #i = 10
  form.t <- ES_known_form$ChemFormula[i]
  
  form.t1 <- data.frame(makeup(form.t))
  setDT(form.t1, keep.rownames = TRUE)[]
  names(form.t1)<- c("Element", "num")
  
  form.t2 <- d.e %>% 
    left_join0(form.t1)
    
  form.t3 <- data.frame(form.t2[,-1])
  rownames(form.t3) <- form.t2[,1]
  
  form.t4 <- data.frame(t(form.t3))
  names(form.t4) <-c("C", "H", "O", "N", "S")
  
  ES_known_form$Cnum[i]= form.t4$C[1]
  ES_known_form$Hnum[i]= form.t4$H[1]
  ES_known_form$Onum[i]= form.t4$O[1]
  ES_known_form$Nnum[i]= form.t4$N[1]
  ES_known_form$Snum[i]= form.t4$S[1]
}

ES_known_form.m <- ES_known_form %>% 
  dplyr::mutate(C_mass = 12*Cnum) %>% 
  dplyr::mutate(tot_mass = (12*Cnum)+(16*Onum)+(Hnum)+(14*Nnum)+(32*Snum)) %>% 
  dplyr::mutate(OM_OC = tot_mass/C_mass) %>% 
  filter(Cnum > 0) 
summary(ES_known_form.m$OM_OC)


# note just picking 1.4 as the organic mass to organic carbon ratio, check with Allen
OM_OC <- 1.3
```

plotting indicators

```{r}
# note that the siloxane peaks (defined as matched with a siloxane MF > 740) are being removed, because they likely were not quantified accurately
# also removing phosphate
M_t_analyte_withIS.q <- M_t_analyte_withIS %>% 
  filter(Compound.Name != "20200803_1535_blob_3_fb") %>% 
  filter(Compound.Name != "20200803_1535_blob_19_") %>% 
  filter(Compound.Name != "20200803_1535_blob_4_") %>% 
  filter(Compound.Name != "20200803_1535_blob_10_") %>% 
  filter(Compound.Name != "20200803_1535_blob_774_") %>% 
  filter(Compound.Name != "20200803_1535_blob_453_") %>% 
  filter(Compound.Name != "20200803_1535_blob_458_") %>% 
  filter(Compound.Name != "20200803_1535_blob_492_") %>%
  filter(Compound.Name != "20200803_0949_blob_1249_") %>%
  left_join(QF_s) %>% 
  dplyr::mutate(amt_ng = vol_is_normnorm * Quant_Factor_final) %>% 
  dplyr::mutate(amt_ng_per_cm3 = amt_ng/(.41*Filter_punches)) %>% 
  dplyr::mutate(amt_ng_ptnorm = amt_ng/Punch_num_sample_time_norm) %>% 
  dplyr::mutate(air_m3_per_cm2 =(1.308*Time_sampled_number*24)/9.6) %>% # see "Sample Needs Estimate CAICE for more, 1.308 is air flow in m3/hr, 9.6 is collection area in cm2 from manufacturer of filter holder
  dplyr::mutate(amt_ng_per_m3_air = amt_ng_per_cm3/air_m3_per_cm2)

#write.csv(M_t_analyte_withIS.q, "quant_inspect.csv")

quant.prob <- M_t_analyte_withIS.q %>% 
  filter(is.na(amt_ng))

table(quant.prob$Compound.Name)
# check out these compounds to see why we dont have quant factors for them

#Now checking to see how our quantification compares to Davis

quant_sum_sample <- M_t_analyte_withIS.q %>% 
  group_by(r_date) %>% 
  summarise(tot_org_ng_cm3 = sum(amt_ng_per_cm3, na.rm = TRUE), 
            tot_org_ng_ptnorm = sum(amt_ng_ptnorm)) %>% 
  left_join(tot_org_o) %>% 
  mutate(OM_FB_corrected = OC_FB_corrected * OM_OC) %>% 
  mutate(frac_fb_rem = (.001*tot_org_ng_cm3)/ OM_FB_corrected)

quant_sum_sample %>% 
  ggplot(aes(x = r_date, y = .001*tot_org_ng_cm3, color = "GCxGC Measured"))+
  geom_point()+
  geom_point(aes(x = r_date, y = OM_FB_corrected, color = "Davis Total Organic Mass"))+
  ylim(0, 3.5)

quant_sum_sample %>% 
  ggplot(aes(x = r_date, y = .001*tot_org_ng_cm3, color = "GCxGC Measured"))+
  geom_point()+
  ylim(0, .7)

quant_sum_sample %>% 
  ggplot(aes(x = r_date, y = frac_fb_rem))+
  geom_point()

quant_sum_sample %>% 
  ggplot()+
  geom_boxplot(aes(x = "x", y = frac_fb_rem))+
  ylim(0, 1)

summary(quant_sum_sample$frac_fb_rem)

sd(quant_sum_sample$frac_fb_rem)


crocker_comp <- read_csv("Read_Files/Organic_Mass_Comparison.csv") %>% 
  mutate(r_date = mdy_hm(Date))

carbon_comp <- crocker_comp %>% 
  ggplot(aes(x = r_date, y = ugC_per_m3_air, color = "GCxGC Analysis\nFilters", 
             shape = "GCxGC Analysis\nFilters"))+
  geom_point(size = 2)+
  geom_point(aes(x = r_date, y = Crocker_ugCperm3, color = "Carbon Isotope\nAnalysis Filters",
                 shape = "Carbon Isotope\nAnalysis Filters"),
             size = 2)+
  scale_shape_manual(name= "OC Quantification\nMethod", labels = c("Carbon Isotope\nAnalysis Filters", "GCxGC Analysis\nFilters"), values = c(17, 19))+
  scale_color_manual(name= "OC Quantification\nMethod", labels = c("Carbon Isotope\nAnalysis Filters", "GCxGC Analysis\nFilters"), values = c("grey20", "orange2"))+
  ylim(0, 1.2)+
  ylab("SSA Organic Carbon\n(ugC/m3)")+
  xlab("")+
  theme_bw(base_size = 14)


carbon_comp

png("carbon_comp_crocker.png", width=6.5, height=4,
    units="in", res=600, pointsize=12)
carbon_comp
dev.off()

crocker_comp %>% 
  ggplot()+
  geom_boxplot(aes(x = "GCxGC Analysis\nFilters", y = ugC_per_m3_air))+
  geom_boxplot(aes(x = "Carbon Isotope\nAnalysis Filters", y = Crocker_ugCperm3))
  

```


Adding fields to cumsum to reflect total org norm and IS normnorm so that factors can be weighted to equally emphasize things important at beginning and end of bloom
```{r}

SeaScape_normalized_cumsum <- M_t_analyte_withIS.q %>% 
  filter(!is.na(amt_ng_ptnorm)) %>% # adding this so that we are only tracking things that are quantified- revisit the missing quants later
  group_by(Compound.Name) %>% 
  summarise(totorgnorm_cumsum = sum(vol_is_normnorm_ptnorm_totorgnorm), isnormnormptnorm_cumsum = sum(vol_is_normnorm_ptnorm), quantcumsum = sum(amt_ng_ptnorm))

tot_norm_vol = sum(SeaScape_normalized_cumsum$isnormnormptnorm_cumsum, na.rm = TRUE)

SeaScape_normalized_cumsum_cumulative <- SeaScape_normalized_cumsum %>% 
  mutate(isnormnormptnorm_pct = isnormnormptnorm_cumsum/tot_norm_vol) %>% 
  mutate(isnormnorm_ptnorm_pct_cumulative = isnormnormptnorm_pct) %>% 
  arrange(desc(isnormnormptnorm_pct)) %>% 
  mutate(rownum = row_number())

for(i in 2:nrow(SeaScape_normalized_cumsum_cumulative)){
  SeaScape_normalized_cumsum_cumulative$isnormnorm_ptnorm_pct_cumulative[i]= SeaScape_normalized_cumsum_cumulative$isnormnormptnorm_pct[i]+ SeaScape_normalized_cumsum_cumulative$isnormnorm_ptnorm_pct_cumulative[i-1]
  
}

tot_org_norm <- sum(SeaScape_normalized_cumsum$quantcumsum)

SeaScape_normalized_cumsum.q <- SeaScape_normalized_cumsum %>% 
  mutate(quant_pct = quantcumsum/tot_org_norm) %>% 
  mutate(quant_pct_cumulative = quant_pct) %>% 
  arrange(desc(quant_pct)) %>% 
  mutate(rownum = row_number())

for(i in 2:nrow(SeaScape_normalized_cumsum.q)){
  SeaScape_normalized_cumsum.q$quant_pct_cumulative[i]= 
    SeaScape_normalized_cumsum.q$quant_pct[i]+ SeaScape_normalized_cumsum.q$quant_pct_cumulative[i-1]
  
}

SeaScape_normalized_cumsum.q %>% 
  ggplot(aes(x = log(rownum), y = quant_pct_cumulative))+
  geom_point()

```


# plotting normalized timelines, normalized by both total organic (red) and internal standard (blue) to get a general sense for underlying trends

```{r}

for(i in 1:50){
  
  print(i)
  big_c <- SeaScape_cumsum_raw$Compound.Name[i]
  
  f4 <- M_t_analyte_withIS %>% 
    filter(Compound.Name == big_c) %>% 
    left_join(compiled_comp_info, by = "Compound.Name") %>% 
    ggplot(aes(x = r_date, y = vol_is_normnorm_ptnorm_totorgnorm, color = Compound.Name))+
    geom_line()+
    geom_point(aes(x = r_date, y = vol_is_normnorm_ptnorm_totorgnorm, shape = T_O_D, fill = Library.Match.Factor_NISTmain))
  
  print(f4)
  
  f5 <- M_t_analyte_withIS %>% 
    filter(Compound.Name == big_c) %>% 
    left_join(compiled_comp_info, by = "Compound.Name") %>% 
    ggplot(aes(x = r_date, y = vol_is_normnorm_ptnorm, color = Compound.Name))+
    geom_line(color = "blue")+
    geom_point(aes(x = r_date, y = vol_is_normnorm_ptnorm, shape = T_O_D, fill = Library.Match.Factor_NISTmain))
  
  print(f5)
  
  
}

```
Plotting Quantified Timelines

```{r}
for(i in 1:50){
  temp_comp <- SeaScape_normalized_cumsum.q$Compound.Name[i]
  
  qf1 <- M_t_analyte_withIS.q %>% 
    filter(Compound.Name == temp_comp) %>% 
    left_join(compiled_comp_info, by = "Compound.Name") %>% 
    ggplot(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
    geom_line()+
    geom_point(aes(x = r_date, y = amt_ng_ptnorm, shape = T_O_D, fill = Library.Match.Factor_NISTmain))
  
  print(qf1)
  
}


```
```{r}
M_t_analyte_withIS.q.0 <- M_t_analyte_withIS.q %>% 
  dplyr::select(Compound.Name, r_date, amt_ng_ptnorm) %>%
  spread(Compound.Name,amt_ng_ptnorm, fill = 0) %>% 
  gather(key = "Compound.Name", value = "amt_ng_ptnorm", -r_date)
```


## Now trying with smoothed long data frame

```{r}
pct_floor = 20 # must be present in at least 20% of samples 
bt_lab <- bt_sum_bloom3 %>% 
  dplyr::select(r_date, Filter_num)

M_t_analyte_withIS_smoothed <- M_t_analyte_withIS.q %>% 
  filter(pct_of_samp > pct_floor) %>% 
  dplyr::select(Compound.Name, r_date, amt_ng_ptnorm) %>%
  spread(Compound.Name,amt_ng_ptnorm, fill = 0) %>% 
  gather(key = "Compound.Name", value = "amt_ng_ptnorm", -r_date) %>% 
  arrange(r_date) %>% 
  arrange(Compound.Name) %>% 
  mutate(amt_ng_ptnorm_smooth = amt_ng_ptnorm) %>% 
  left_join(bt_lab)

for(i in 2:nrow(M_t_analyte_withIS_smoothed)){

  a = i-1
  b = i
  c = i+1
  n1 <- M_t_analyte_withIS_smoothed$amt_ng_ptnorm[a]
 n2 <- M_t_analyte_withIS_smoothed$amt_ng_ptnorm[b]
 n3 <- M_t_analyte_withIS_smoothed$amt_ng_ptnorm[c]
 
 
  
  if(M_t_analyte_withIS_smoothed$Filter_num[i] == "UCB19_A_153"){
    M_t_analyte_withIS_smoothed$amt_ng_ptnorm_smooth[i]= n2
  }else if(M_t_analyte_withIS_smoothed$Filter_num[i] == "UCB19_A_197"){
    M_t_analyte_withIS_smoothed$amt_ng_ptnorm_smooth[i]= n2
  }else{
    nn <- (n1+n2+n3)/3
    M_t_analyte_withIS_smoothed$amt_ng_ptnorm_smooth[i]<- nn
    
  }
    
    
}
  
tt <- M_t_analyte_withIS_smoothed[21867,]


```



# Trying hierarchical clustering because DFA not working well

```{r}
library(tidyr)
library(dtwclust)
library(dplyr)
library(ggplot2)
#install.packages("reshape")
library(reshape)
```

```{r}

n_obs <- 100 # number of observations to keep for the factorization. 100 compounds is ~90% of the mass, so going with this. 
#n_factors <- 5

cumsum_keep <- SeaScape_normalized_cumsum.q[1:n_obs,]

cumsum_keep <- cumsum_keep %>% 
  mutate(keep = 1) %>% 
  dplyr::select(Compound.Name, keep)



df_long <- M_t_analyte_withIS_smoothed %>% 
  left_join(cumsum_keep) %>% 
  filter(keep == 1) %>% 
  dplyr::select(Compound.Name, r_date, amt_ng_ptnorm_smooth)



df_list <- as.list(utils::unstack(df_long, amt_ng_ptnorm_smooth ~ Compound.Name))

df_list_z <- dtwclust::zscore(df_list)

set.seed(20)
cluster_dtw_h <-list()
for (i in 2:20)
{
  cluster_dtw_h[[i]] <- tsclust(df_list_z, type = "h", k = i,  distance = "dtw", control = hierarchical_control(method = "complete"), seed = 590, preproc = NULL, args = tsclust_args(dist = list(window.size = 5L)))
}

# take a look at the object
cluster_dtw_h[[8]]

plot(cluster_dtw_h[[8]], type = "sc")
plot(cluster_dtw_h[[7]], type = "sc")
plot(cluster_dtw_h[[6]], type = "sc")
plot(cluster_dtw_h[[5]], type = "sc")
plot(cluster_dtw_h[[4]], type = "sc")
plot(cluster_dtw_h[[3]], type = "sc")

final.clust <- cluster_dtw_h[[8]]

plot(final.clust, type = "sc")

1
cvi(cluster_dtw_h[[4]], type = "valid")
cvi(cluster_dtw_h[[5]], type = "valid")
cvi(cluster_dtw_h[[6]], type = "valid")
cvi(cluster_dtw_h[[7]], type = "valid")
cvi(cluster_dtw_h[[8]], type = "valid")
cvi(cluster_dtw_h[[9]], type = "valid")
cvi(cluster_dtw_h[[10]], type = "valid")

sil.d <- c(.303, .297, .282, .275, .218, .225, .227)
sil.i <- c(4, 5, 6, 7, 8, 9, 10)
sil.plot <- data.frame(n_cluster = sil.i, sil = sil.d)

sil.plot.p <- sil.plot %>% 
  ggplot(aes(x = n_cluster, y = sil))+
  geom_line()+
  geom_point()+
  ylim(.2, .35)+
  xlab("Number of Clusters")+
  ylab("Silhouette Index")+
  theme_bw(base_size = 14)

sil.plot.p

png("silhouette.index.png", width=6, height=5,
    units="in", res=600, pointsize=12)
sil.plot.p
dev.off()

# from this appears that 8 clusters is ideal, based on maximizing Sil
```


```{r}
fit <- cluster_dtw_h[[8]]
clustered_data <- cutree(fit, k=8)
clustered_data_tidy <- as.data.frame(as.table(clustered_data)) %>% glimpse()
colnames(clustered_data_tidy) <- c("Compound.Name","cluster")
clustered_data_tidy$Compound.Name <- as.character(clustered_data_tidy$Compound.Name)
glimpse(clustered_data_tidy)
table(clustered_data_tidy$cluster)

clustered_data_tidy <- clustered_data_tidy %>% 
  mutate(Compound.Name = sub('.', '', Compound.Name))

smoothed_zscoreparams <- M_t_analyte_withIS_smoothed %>% 
  group_by(Compound.Name) %>% 
  summarise(c.mean = mean(amt_ng_ptnorm_smooth), c.stdev = sd(amt_ng_ptnorm_smooth))

M_t_analyte_withIS_smoothed.zscore <- M_t_analyte_withIS_smoothed %>% 
  left_join(smoothed_zscoreparams) %>% 
  mutate(amt_ng_ptnorm_smooth.zscore = (amt_ng_ptnorm_smooth-c.mean)/c.stdev)

h.clust.factors.z <- read_csv("Read_Files/Cluster_labels.csv") %>% 
  mutate(cluster_factor_types.f = fct_reorder(cluster_factor_types, order))

cluster_vis <- M_t_analyte_withIS_smoothed.zscore %>% 
  left_join(clustered_data_tidy) %>% 
  filter(!is.na(cluster)) %>% 
  left_join(h.clust.factors.z) 

cluster_vis.p <- cluster_vis %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm_smooth.zscore, color = Compound.Name))+
  geom_line(show.legend = FALSE)+
  facet_wrap(~ cluster_factor_types.f)+
  theme_bw(base_size = 12)+
  ylab("Concentration (Z-Scored)")+
  xlab("")

cluster_vis.p
  
  
png("clustervis.png", width=8, height=6,
    units="in", res=600, pointsize=12)
cluster_vis.p
dev.off()

```

```{r}




```


```{r}

# classifying as biogenic
cluster_1 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 1) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_1 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 1")

cluster_2 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 2) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_2 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 2")

cluster_3 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 3) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_3 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 3")

# note factor 4 contains btz- classifying as mixed
cluster_4 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 4) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_4 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 4")

cluster_5 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 5) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_5 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 5")

cluster_6 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 6) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_6 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 6")

cluster_7 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 7) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_7 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 7")

cluster_8 <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(cluster == 8) %>% 
  group_by(r_date) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_8 %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z))+
  geom_line()+
  ggtitle("Cluster 8")

cluster_all <- M_t_analyte_withIS_smoothed.zscore %>%
  left_join(clustered_data_tidy) %>% 
  filter(!is.na(cluster)) %>% 
  group_by(r_date, cluster) %>% 
  summarise(cluster_vol.z = mean(amt_ng_ptnorm_smooth.zscore))

cluster_all %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z, color = as.factor(cluster)))+
  geom_line()
```


```{r}
# h.clust.factors.z <- data.frame(cluster = c(1,2,3,4,6,5,7,8,9), cluster_factors = c("Factor A", "Factor B", "Factor C", "Factor D", "Factor F", "Factor E", "Factor G", "Factor H", "Factor I"), cluster_factor_types = c("Biogenic1", "Anthro1", "Mixed4", "Mixed2", "Mixed1", "Anthro2", "Mixed3", "Mixed5", "R-Btz"))
library(forcats)


cluster_all %>% 
  left_join(h.clust.factors.z) %>% 
  ggplot(aes(x = r_date, y = cluster_vol.z, color = as.factor(cluster_factor_types)), size = 1.2)+
  geom_line()+
  geom_point(data = bt_sum_bloom3, aes(x = r_date, y = Extracted_Chla/10), color = "green1", size = 2)+
  geom_point(data = bt_sum_bloom3, aes(x = r_date, y = Bulk_HB/3000000), color = "red1", size = 2)




smooth_zscore_forcorr <- M_t_analyte_withIS_smoothed.zscore %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm_smooth.zscore) %>% 
  spread(Compound.Name, amt_ng_ptnorm_smooth.zscore) %>% 
  dplyr::select(-r_date)

smooth_zscore_forcorr$F1 <- cluster_1$cluster_vol.z
smooth_zscore_forcorr$F2 <- cluster_2$cluster_vol.z
smooth_zscore_forcorr$F3 <- cluster_3$cluster_vol.z
smooth_zscore_forcorr$F4 <- cluster_4$cluster_vol.z
smooth_zscore_forcorr$F5 <- cluster_5$cluster_vol.z
smooth_zscore_forcorr$F6 <- cluster_6$cluster_vol.z
smooth_zscore_forcorr$F7 <- cluster_7$cluster_vol.z
smooth_zscore_forcorr$F8 <- cluster_8$cluster_vol.z





hclust_smooth_zscore_corr <- data.frame(cor(smooth_zscore_forcorr), use = "pairwise.complete.obs")

just_cluster_corr <-  hclust_smooth_zscore_corr %>% 
  dplyr::select(F1, F2, F3, F4, F5, F6, F7, F8) 


assignments <- colnames(just_cluster_corr)[max.col(just_cluster_corr, ties.method = "first")]



just_cluster_corr$best_corr <- assignments

cluster_corr_hclust <- just_cluster_corr %>% 
  rownames_to_column(var = "Compound.Name") %>% 
  filter(Compound.Name != "F1") %>% 
  filter(Compound.Name != "F2") %>%
  filter(Compound.Name != "F3") %>% 
  filter(Compound.Name != "F4") %>% 
  filter(Compound.Name != "F5") %>% 
  filter(Compound.Name != "F6") %>% 
  filter(Compound.Name != "F7") %>% 
  filter(Compound.Name != "F8") %>% 
  left_join(clustered_data_tidy)

table(cluster_corr_hclust$best_corr)

cluster_corr_infor <- cluster_corr_hclust %>% 
  left_join(compiled_comp_info)

#write.csv(cluster_corr_infor, "cluster_correlation_info_inspect.csv")

cluster_assignments <- read_csv("Read_Files/Cluster_Assignments_Manual_Check_SeaScape_2.csv") %>% 
  dplyr::select(Compound.Name, cluster_assigned)

h.clust.factors <- h.clust.factors.z %>% 
  dplyr::rename(cluster_assigned = cluster)

comp_info_cluster_quant <- compiled_comp_info %>% 
  left_join(cluster_assignments) %>% 
  left_join(SeaScape_normalized_cumsum.q) %>% 
  left_join(h.clust.factors)

write.csv(comp_info_cluster_quant, "Write_Files/Compiled_Compound_Info_clusters_quant.csv")

```

```{r}
bio_markers1 <- bt_sum_bloom3 %>% 
  dplyr::select(Event_label, r_date, Event_lab_order) %>% 
  filter(!is.na(Event_label)) %>% 
  mutate(biomarker_mag= 4)

bio_markers2 <- bt_sum_bloom3 %>% 
  dplyr::select(Event_label, r_date, Event_lab_order) %>% 
  filter(!is.na(Event_label)) %>% 
  mutate(biomarker_mag= -2)

bio_markers <- rbind(bio_markers1, bio_markers2)
```


```{r}
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

n = 8
#cols = gg_color_hue(n)

#cols = c("#CC6677", "#661100", "#882255",  "#44AA99", "#117733",  "#88CCEE","#332288","#6699CC")
cols = c("#CC6677", "#661100", "#CC3333",  "#669900", "#336600",  "#9966FF","#660066","#9933CC")

cols2 = c("#CC6677", "#661100", "#CC3333",  "#9966FF","#660066","#9933CC", "#669900", "#336600")
         
          

dev.new(width = 4, height = 4)
plot(1:n, pch = 16, cex = 2, col = cols)
```

```{r}
maxh <- max(cluster_all$cluster_vol.z)
minh <- min(cluster_all$cluster_vol.z)

chla_hb <- bt_sum_bloom3 %>% 
  dplyr::select(r_date, Extracted_Chla, Bulk_HB_updated) %>% 
  filter(!is.na(Extracted_Chla))

max_chla <- max(chla_hb$Extracted_Chla)
max_hb <- max(chla_hb$Bulk_HB_updated)

chla_hb <- chla_hb %>% 
  mutate(chla_norm = Extracted_Chla/max_chla) %>% 
  mutate(hb_norm = Bulk_HB_updated/ max_hb)


hclust_anthro <- cluster_all %>% 
  left_join(h.clust.factors.z) %>% 
  filter(cluster_group == "Anthropogenic")

pan<- ggplot()+
  geom_col(data = bio_markers, aes(x = r_date, y = biomarker_mag, fill = Event_label), width = 20000)+
  geom_line(data = hclust_anthro, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  ylab("Mean Cluster Abundance\n(Z-Scored)")+
  ggtitle("Anthropogenic Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5),legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[1:3])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c( "Peak Chlorophyll", "Peak Bacteria"))+
  guides(fill = guide_legend(order = 1),color = guide_legend(order = 2))

pan

png("anthro_clusters3b.png", width=8, height=5,
    units="in", res=600, pointsize=12)
pan
dev.off()

pan2<- ggplot()+
  geom_ribbon(data = chla_hb, aes(x = r_date, ymax = chla_norm*4), 
              ymin = 0, fill = "green4", alpha = .3)+
  geom_ribbon(data = chla_hb, aes(x = r_date, ymax = hb_norm*4), 
              ymin = 0, fill = "blue4", alpha = .3)+
  geom_line(data = hclust_anthro, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  #ylab("Mean Cluster Abundance\n(Z-Scored)")+
  ggtitle("Anthropogenic Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5),legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  scale_y_continuous(
    
    # Features of the first axis
    name = "Mean Cluster Abundance\n(Z-Scored)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis( trans=~.*.25, name="Normalized Bioindicator \nConcentration (in Water)")
  ) +
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[1:3])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c( "Peak Chlorophyll", "Peak Bacteria"))+
  guides(fill = guide_legend(order = 1),color = guide_legend(order = 2))

pan2



hclust_mix <- cluster_all %>% 
  left_join(h.clust.factors.z) %>% 
  filter(cluster_group == "Mixed")

pmix<- ggplot()+
  geom_col(data = bio_markers, aes(x = r_date, y = biomarker_mag, fill = Event_label), width = 20000)+
  geom_line(data = hclust_mix, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  ylab("Mean Cluster Abundance\n(Z-Scored)")+
  ggtitle("Mixed Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[6:8])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c("Peak Chlorophyll", "Peak Bacteria"))

pmix

png("mixed_clusters2b.png", width=8, height=5,
    units="in", res=600, pointsize=12)
pmix
dev.off()

pmix2<- ggplot()+
  geom_ribbon(data = chla_hb, aes(x = r_date, ymax = chla_norm*4), 
              ymin = 0, fill = "green4", alpha = .3)+
  geom_ribbon(data = chla_hb, aes(x = r_date, ymax = hb_norm*4), 
              ymin = 0, fill = "blue4", alpha = .3)+
  geom_line(data = hclust_mix, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  #ylab("Mean Cluster Abundance\n(Z-Scored)")+
  ggtitle("Mixed Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  scale_y_continuous(
    
    # Features of the first axis
    name = "Mean Cluster Abundance\n(Z-Scored)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis( trans=~.*.25, name="Normalized Bioindicator \nConcentration (in Water)")
  ) +
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[6:8])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c("Peak Chlorophyll", "Peak Bacteria"))

pmix2


hclust_bio <- cluster_all %>% 
  left_join(h.clust.factors.z) %>% 
  #filter(cluster_factors == "Factor A" | cluster_factors == "Factor E")
  filter(cluster_group == "Biogenic")

pbio<- ggplot()+
  
  geom_col(data = bio_markers, aes(x = r_date, y = biomarker_mag, fill = Event_label), width = 20000)+
  geom_line(data = hclust_bio, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  ylab("Mean Cluster Abundance\n(Z-Scored)")+
  ggtitle("Biogenic Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[4:5])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c("Peak Chlorophyll", "Peak Bacteria"))

pbio
# check corr with diatom aggregates

png("biogenic_clusters2b.png", width=8, height=5,
    units="in", res=600, pointsize=12)
pbio
dev.off()

pbio2<- ggplot()+
  geom_ribbon(data = chla_hb, aes(x = r_date, ymax = chla_norm*4), 
              ymin = 0, fill = "green4", alpha = .3)+
  geom_ribbon(data = chla_hb, aes(x = r_date, ymax = hb_norm*4), 
              ymin = 0, fill = "blue4", alpha = .3)+
  geom_line(data = hclust_bio, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  #ylab("Mean Cluster Abundance\n(Z-Scored)")+
  ggtitle("Biogenic Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  scale_y_continuous(
    
    # Features of the first axis
    name = "Mean Cluster Abundance\n(Z-Scored)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis( trans=~.*.25, name="Normalized Bioindicator \nConcentration (in Water)")
  ) +
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[4:5])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c("Peak Chlorophyll", "Peak Bacteria"))

pbio2




chla_hb %>% 
  ggplot(aes(x = r_date, y = chla_norm))+
  geom_line(color = "green3", size = 1.2)+
  geom_line(aes(x = r_date, y = hb_norm), color = "blue2", size = 1.2)+
  geom_col(data = bio_markers1, aes(x = r_date, y = biomarker_mag/4, fill = Event_label), width = 20000)+
  theme_bw()+
  ylab("Normalized Concentration")+
  scale_fill_manual(values = c( "darkgreen", "blue4"), labels = c("Peak Chla", "Peak Bacteria"))+
  theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_blank(), axis.title.y = element_text(size = 20))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")

chlaplot <- chla_hb %>% 
  ggplot(aes(x = r_date, y = chla_norm, color = "Chlorophyll A"))+
  geom_line(size = 1.2)+
  geom_line(aes(x = r_date, y = hb_norm, color = "Heterotrophic Bacteria"), size = 1.2)+
  theme_bw()+
  scale_color_manual(values = c("darkgreen", "blue4"), labels = c("Chlorophyll-a", "Heterotrophic \nBacteria"))+
  ylab("Bulk Water Concentration\n (Normalized)")+
  ggtitle("Algal Bloom Biological Indicators")+
  theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_blank(), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")

png("Chlorophyll_hb3b.png", width=8, height=5,
    units="in", res=600, pointsize=12)
chlaplot
dev.off()


```

Setting up panels for final aesthetic choices

```{r}
date.s <- chla_hb$r_date[2]
date.e <- chla_hb$r_date[17]

pan.f<- ggplot()+
  #geom_col(data = bio_markers, aes(x = r_date, y = biomarker_mag, fill = Event_label), width = 20000)+
  geom_line(data = hclust_anthro, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  ylab("Mean Cluster\nAbundance (Z-Scored)")+
  ggtitle("Aerosol Organics:\nAnthropogenic Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5, vjust = -2),legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_blank(), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18), 
        legend.position = c(.8, .8), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[1:3])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c( "Peak Chlorophyll", "Peak Bacteria"))+
  ylim(-2, 4)+
  guides(fill = guide_legend(order = 1),color = guide_legend(order = 2))

pan.f

pbio.f<- ggplot()+
  
  #geom_col(data = bio_markers, aes(x = r_date, y = biomarker_mag, fill = Event_label), width = 20000)+
  geom_line(data = hclust_bio, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  ylab("Mean Cluster\nAbundance (Z-Scored)")+
  ggtitle("Aerosol Organics:\nBiogenic Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5, vjust = -2),legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_blank(), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18), 
        legend.position = c(.8, .8), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  ylim(-2, 4)+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[4:5])+
  scale_fill_manual(values = c("darkgreen", "blue4"), labels = c("Peak Chlorophyll", "Peak Bacteria"))

pbio.f

pmix.f<- ggplot()+
  #geom_col(data = bio_markers, aes(x = r_date, y = biomarker_mag, fill = Event_label), width = 20000)+
  geom_line(data = hclust_mix, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  ylab("Mean Cluster\nAbundance (Z-Scored)")+
  ggtitle("Aerosol Organics:\nMixed Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5, vjust = -2),legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_blank(), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18), 
        legend.position = c(.77, .8), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  ylim(-2, 4)+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[6:8])

pmix.f

chla_hb.l <- chla_hb %>% 
  dplyr::select(r_date, chla_norm, hb_norm) %>% 
  gather(key = "bio_cat", value = "normalized_conc", -r_date)

chla_hb.f <- ggplot()+
  geom_line(data = chla_hb.l, aes(x = r_date, y = normalized_conc, color = bio_cat), size = 1.2)+
  theme_bw()+
  ylab("Normalized \nConcentration (in Water)")+
  ggtitle("Biological Activity Indicators")+
  theme(plot.title = element_text(size = 18, hjust = 0.5),legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.y = element_text(size = 18), axis.text.x = element_text(size = 18), axis.title.y = element_text(size = 18), 
        legend.position = c(.2, .8), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
  # theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18), legend.position = c(.2, .8))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  ylim(0, 1)+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = c("green4", "blue4"), labels = c("Chlorophyll-a", "\nHeterotrophic\nBacteria"))

chla_hb.f 

library(ggpubr)
bioi <- ggarrange(pan.f, pbio.f, pmix.f, chla_hb.f, heights = c(3, 3, 3, 3.2), 
          labels = c("A", "B", "C", "D"),
          ncol = 1, nrow = 4, align = "v")

bioi

png("bioind10.png", width=6, height=14,
    units="in", res=600, pointsize=12)
bioi
dev.off()
```

Now comparing speciated biology time series to the cluster time series

```{r}
bio_spec <- read_csv("Read_Files/Speciated_Biology_Time_Series_scaled.csv") %>% 
  mutate(r_date =    mdy_hm(SS_startdate))

bs.p <- bio_spec %>% 
  filter(!is.na(Diatoms)) %>% 
  ggplot()+
  geom_line(aes(x = r_date, y= Mixed_Aggregates, color = "Mixed_Aggregates"))+
  geom_line(aes(x = r_date, y= Diatom_Dominated_Aggregates, color = "Diatom_Dom_Aggregates"))+
  geom_line(aes(x = r_date, y= Dinoflagellates, color = "Dinoflagellates"))+
  geom_line(aes(x = r_date, y= Microzooplankton, color = "Mzoo"))+
  geom_line(aes(x = r_date, y= Diatoms, color = "Diatoms"))+
  geom_line(aes(x = r_date, y= Haptophytes, color = "Haptophytes"))

bs.p

bs.p + 
  ylim(0, 400000)

pbio2<- ggplot()+
  geom_line(data = bio_spec, aes(x = r_date, y = (Diatom_Dominated_Aggregates_pct*10)-2), color = "black")+
  geom_line(data = bio_spec, aes(x = r_date, y = (Haptophytes_pct*20)-1), color = "blue")+
  #geom_line(data = bio_spec, aes(x = r_date, y = (Microzooplankton_pct*20)-1), color = "red")+
  geom_line(data = bio_spec, aes(x = r_date, y = (Diatoms_pct*6)-2), color = "red")+
  geom_line(data = hclust_bio, aes(x = r_date, y = cluster_vol.z, color = cluster_factor_types), size = 1.2)+
  theme_bw()+
  ylab("Mean Cluster Abundance\n(Z-Scored)")+
  ggtitle("Biogenic Influence Clusters")+
  theme(plot.title = element_text(size = 18, hjust = 0.5), legend.text = element_text(size = 16), legend.title = element_blank(), axis.text.x = element_text(size = 18), axis.text.y = element_text(size = 18), axis.title.y = element_text(size = 18))+
  #ylim(minh, maxh)+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))+
  xlab("")+
  #guides(fill=guide_legend(nrow=2,byrow=TRUE))+
  scale_color_manual(values = cols[4:5])
  #scale_color_manual(values = cols[3:4], labels = c("Biogenic A", "Biogenic B"))




pbio2

bio_corr <-M_t_analyte_withIS.q.0 %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm) %>% 
  spread(Compound.Name,amt_ng_ptnorm, fill = 0) %>% 
  left_join(bio_spec) %>% 
  filter(!is.na(SS_startdate)) %>% 
  dplyr::select(-c(r_date, SS_startdate))

bio.cor <- cor(bio_corr, use = "pairwise.complete.obs") 

write.csv(bio.cor, "correlation_inspection4.csv")



bio.cor.info <- read_csv("correlation_inspection_ed4_virus_hb_chla.csv")%>% 
  left_join(cluster_assignments) %>% 
  left_join(h.clust.factors) %>% 
  left_join(SeaScape_normalized_cumsum.q) %>% 
  left_join(compiled_comp_info) 

table(bio.cor.info$cluster_factor_types)

write.csv(bio.cor.info, "correlation_info_inspection4.csv")
```


```{r}
bio.cor.HB.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = HB_cells_L, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.HB.pt

bio.cor.virus.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = Virus_L, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.virus.pt

bio.cor.Hapto.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = Haptophytes, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.Hapto.pt

bio.cor.DDA.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = Diatom_Dominated_Aggregates, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.DDA.pt

bio.cor.Mzoo.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = Microzooplankton, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.Mzoo.pt

bio.cor.Dia.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = Diatoms, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.Dia.pt

bio.cor.MixedAg.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = Mixed_Aggregates, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.MixedAg.pt

bio.cor.Dino.pt <- bio.cor.info %>% 
  filter(!is.na(cluster_factor_types)) %>% 
  ggplot(aes(x = cluster_factor_types, y = Dinoflagellates, fill = cluster_factor_types))+
  geom_boxplot()+
  scale_fill_manual(name = "", values = cols[1:8])+
  ggtitle("Bio Correlation Coefficients \nBy Cluster")+
  ylim(-1, 1)

bio.cor.Dino.pt


bio.cor.info.sum <- bio.cor.info %>% 
  group_by(cluster_factor_types) %>% 
  summarise(Mixed_Aggregates = mean(Mixed_Aggregates, na.rm = TRUE),
            Diatom_Dominated_Aggregates = mean(Diatom_Dominated_Aggregates, na.rm = TRUE),
            Dinoflagellates = mean(Dinoflagellates, na.rm = TRUE),
            Microzooplankton = mean(Microzooplankton, na.rm = TRUE),
            Diatoms = mean(Diatoms, na.rm = TRUE),
            Haptophytes = mean(Haptophytes, na.rm = TRUE),
            HB_cells_L = mean(HB_cells_L, na.rm = TRUE),
            Virus_L = mean(Virus_L, na.rm = TRUE),
            Chla = mean(Chlor_a, na.rm = TRUE)) %>% 
  gather("bio_spec", "avg_r", 2:10) %>% 
  filter(!is.na(cluster_factor_types))

bio.cor.info.sum %>% 
  ggplot(aes(y = bio_spec, x = cluster_factor_types, fill = avg_r, 
             color = as.factor(cluster_factor_types), width = .8, height = .8))+
  geom_tile(size = 1.5)+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  scale_color_manual(values = cols[1:8])+
  theme_bw()+
   theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
  guides(color = FALSE)
```


```{r}
bio.spec.names <- read_csv("Read_Files/bioindicator_levels.csv") %>% 
  mutate(bio_spec.f = fct_reorder(bio_spec, levels)) %>% 
  mutate(bio_spec_names.f = fct_reorder(bio_spec_names, levels)) %>% 
  arrange(desc(levels))


#my.labels <- bio.spec.names$bio_spec_names
my.labels <- c("Viruses","Heterotrophic\nBacteria",  
               "Microzooplankton", "Diatom\nDominated\nAggregates", "Diatoms",
               "Chlorophyll-a")
my.labels2 <- c("Chlorophyll-a", "Diatoms","Diatom\nDominated\nAggregates", 
                "Microzooplankton", "Heterotrophic\nBacteria", "Viruses")

cor.plot.biospec <- bio.cor.info.sum %>% 
  left_join(h.clust.factors.z) %>% 
  left_join(bio.spec.names)

bio.cor.info.sum %>% 
  left_join(h.clust.factors.z) %>% 
  left_join(bio.spec.names) %>% 
  filter(!is.na(levels)) %>% 
   # filter(bio_spec == "Virus_L"| bio_spec == "Microzooplankton"| bio_spec == "HB_cells_L"| 
   #        bio_spec == "Diatoms"| bio_spec == "Diatom_Dominated_Aggregates") %>% 
   ggplot(aes(y = bio_spec_names.f, x = cluster_factor_types.f, fill = avg_r))+
  geom_tile(size = 1.5)+
  scale_fill_gradient2(low = "darkblue", high = "darkgoldenrod2", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Average\nPearson\nCorrelation") +
  scale_color_manual(values = cols[1:8])+
  scale_y_discrete(labels= my.labels)+
  theme_bw()+
   theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
  guides(color = FALSE)

a <- cols2

bio.c.plot <- bio.cor.info.sum %>% 
  left_join(h.clust.factors.z) %>% 
  left_join(bio.spec.names) %>% 
  filter(!is.na(levels)) %>% 
   # filter(bio_spec == "Virus_L"| bio_spec == "Microzooplankton"| bio_spec == "HB_cells_L"| 
   #        bio_spec == "Diatoms"| bio_spec == "Diatom_Dominated_Aggregates") %>% 
   ggplot(aes(y = bio_spec_names.f, x = cluster_factor_types.f, fill = avg_r))+
  geom_tile(size = 1.5)+
  scale_fill_gradient2(low = "royalblue4", high = "darkgoldenrod2", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Average\nPearson\nCorrelation") +
  scale_color_manual(values = cols[1:8])+
  scale_y_discrete(labels= my.labels2)+
  ylab("")+
  xlab("")+
  theme_bw(base_size = 12)+
   theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1, color = a))+
  guides(color = FALSE)

bio.c.plot

png("bio_cor_plot5.png", width=5.5, height=3.5,
    units="in", res=600, pointsize=12)
bio.c.plot
dev.off()

bio.cor.info.sum %>% 
  left_join(h.clust.factors.z) %>% 
  left_join(bio.spec.names) %>% 
  filter(!is.na(levels)) %>% 
   # filter(bio_spec == "Virus_L"| bio_spec == "Microzooplankton"| bio_spec == "HB_cells_L"| 
   #        bio_spec == "Diatoms"| bio_spec == "Diatom_Dominated_Aggregates") %>% 
   ggplot(aes(y = bio_spec_names.f, x = cluster_factor_types.f, fill = avg_r))+
  geom_tile(size = 1.5)+
  scale_fill_gradient2(low = "darkslategrey", high = "darkgoldenrod2", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Average\nPearson\nCorrelation") +
  scale_color_manual(values = cols[1:8])+
  #scale_y_discrete(labels= my.labels2)+
  theme_bw()+
   theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
  guides(color = FALSE)



```


```{r}
bio.data.pts <- bio_spec %>% 
  dplyr::select(r_date) %>% 
  mutate(bio.dat.inc = TRUE)

Hphyte.comp.pos <- bio.cor.info %>% 
  filter(quant_pct > .003) %>% 
  filter(Haptophytes > .6) %>% 
  mutate(keep = 1) 

Hphyte.comp.neg <- bio.cor.info %>% 
  filter(quant_pct > .005) %>% 
  filter(Haptophytes < -.6) %>% 
  mutate(keep = 1) 

tt <- M_t_analyte_withIS.q.0 %>% 
  left_join(Hphyte.comp.pos) %>% 
  filter(keep == 1) 

Hapto.pos.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(Hphyte.comp.pos) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Haptophytes) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))


Hapto.pos.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Haptophytes/1000))+
  ggtitle("Haptophytes")

Hapto.neg.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(Hphyte.comp.neg) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Haptophytes) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))

Hapto.neg.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Haptophytes/10000))+
  ggtitle("Haptophytes")


table(Hapto.neg.plot$Compound.Name)

DDA.comp.neg <- bio.cor.info %>% 
  filter(quant_pct > .005) %>% 
  filter(Diatom_Dominated_Aggregates < -.6) %>% 
  mutate(keep = 1) 

DDA.neg.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(DDA.comp.neg) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Diatom_Dominated_Aggregates) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))

DDA.neg.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Diatom_Dominated_Aggregates/100000))+
  ggtitle("DDA")

DDA.comp.pos <- bio.cor.info %>% 
  filter(quant_pct > .003) %>% 
  filter(Diatom_Dominated_Aggregates > .6) %>% 
  mutate(keep = 1) 

DDA.pos.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(DDA.comp.pos) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Diatom_Dominated_Aggregates) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))

DDA.pos.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Diatom_Dominated_Aggregates/500000))+
  ggtitle("DDA")

######

Mzoo.comp.pos <- bio.cor.info %>% 
  filter(quant_pct > .003) %>% 
  filter(Microzooplankton > .6) %>% 
  mutate(keep = 1) 

Mzoo.pos.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(Mzoo.comp.pos) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Haptophytes) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))

Mzoo.pos.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Microzooplankton/1000))+
  ggtitle("Microzooplankton")

Mzoo.comp.neg <- bio.cor.info %>% 
  filter(quant_pct > .001) %>% 
  filter(Microzooplankton < -.6) %>% 
  mutate(keep = 1) 

Mzoo.neg.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(Mzoo.comp.neg) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Haptophytes) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))

Mzoo.neg.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Microzooplankton/80000))+
  ggtitle("Microzooplankton")

###

Dia.comp.pos <- bio.cor.info %>% 
  filter(quant_pct > .0005) %>% 
  filter(Diatoms > .6) %>% 
  mutate(keep = 1) 

Dia.pos.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(Dia.comp.pos) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Diatoms) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))

Dia.pos.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Diatoms/500000))+
  ggtitle("Diatoms")

Dia.comp.neg <- bio.cor.info %>% 
  filter(quant_pct > .001) %>% 
  filter(Diatoms < -.6) %>% 
  mutate(keep = 1) 

Dia.neg.plot <- M_t_analyte_withIS.q.0 %>% 
  left_join(bio.data.pts) %>% 
  filter(bio.dat.inc == TRUE) %>% 
  left_join(Dia.comp.neg) %>% 
  filter(keep == 1) %>% 
  dplyr::select(r_date, Compound.Name, amt_ng_ptnorm, Diatoms) %>% 
  mutate(Compound.Name = as.factor(Compound.Name))

Dia.neg.plot %>%  
  ggplot()+
  geom_line(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
  geom_line(data = bio_spec, aes(x = r_date, y = Diatoms/200000))+
  ggtitle("Diatoms")


```

Now looking at knowledge of the different clusters

```{r}
identifications_confirmed <- read_csv("Read_Files/Confirmed_Identifications.csv")

knowledge_clusters <- cluster_assignments %>% 
  left_join(identifications_confirmed) %>% 
  mutate(ID_c = !Model_Properties) %>% 
  left_join(h.clust.factors) %>% 
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q) %>% 
  mutate(tic = 1)

knowledge_clusters %>% 
  ggplot(aes(x = cluster_factor_types, y = quant_pct, fill = Identifiable))+
  geom_col()

knowledge_clusters %>% 
  ggplot(aes(x = cluster_factor_types, y = tic, fill = Identifiable))+
  geom_col()

knowledge_clusters %>% 
  ggplot(aes(x = cluster_factor_types, y = quant_pct, fill = ID_c))+
  geom_col()

knowledge_clusters %>% 
  filter(!is.na(cluster_group)) %>% 
  ggplot(aes(x = cluster_group, y = quant_pct, fill = ID_c))+
  geom_col()+
  ylab("Cumulative Organic Mass")+
  xlab("")+
  scale_fill_manual(name = "Identifiable by\nDatabase Match", values = c("grey33", "grey60"))+
  theme_bw(base_size = 14)

know.p.1 <- knowledge_clusters %>% 
  filter(!is.na(cluster_group)) %>% 
  ggplot(aes(x = cluster_group, y = quant_pct, fill = ID_c))+
  geom_col(position = "fill")+
  ylab("Fraction Cluster\nCategory Mass")+
  xlab("")+
  theme_bw(base_size = 14)+
  #theme(axis.text.x = element_text(angle = 45))+
   theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     size = 14, hjust = 1))+
  scale_fill_manual(name = "Identifiable by\nDatabase Match", values = c("grey33", "grey60"))
  

know.p.1

png("know.p.5.png", width=5, height=3.5,
    units="in", res=600, pointsize=12)
know.p.1
dev.off()

know.t <- M_t_analyte_withIS.q.0 %>% 
  left_join(identifications_confirmed) %>% 
  mutate(ID_c = !Model_Properties) %>% 
  filter(!is.na(ID_c)) %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = ID_c))+
  geom_col(position = "fill")+
  ylab("Fraction Recovered Mass")+
  xlab("")+
  theme_bw(base_size = 14)+
  scale_fill_manual(name = "Identifiable by\nDatabase Match", values = c("grey33", "grey60"))

png("know.t.png", width=5.5, height=3.5,
    units="in", res=600, pointsize=12)
know.t
dev.off()

```






```{r}
M_t_analyte_withIS.hclust <- M_t_analyte_withIS.q %>% 
  left_join(cluster_corr_hclust) %>% 
  left_join(cluster_assignments) %>% 
  mutate(cluster_combined = ifelse(is.na(cluster), sub('.', '', best_corr), cluster)) 

hclust_factors_compinfo <- cluster_corr_hclust %>% 
  mutate(cluster_combined = ifelse(is.na(cluster), sub('.', '', best_corr), cluster)) %>% 
  right_join(compiled_comp_info)

M_t_analyte_withIS.hclust %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = as.factor(best_corr))) +
  geom_col(position = "fill")


M_t_analyte_withIS.hclust %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = as.factor(cluster))) +
  geom_col(position = "fill")

# h.clust.factors <- data.frame(cluster_combined = as.factor(c(1,2,3,4,5,6,7,8)), cluster_factors = c("Factor A", "Factor C", "Factor B", "Factor G", "Factor D", "Factor F", "Factor E", "Factor H"), cluster_factor_types = c("Anthroporenic", "Mixed", "Anthropogenic", "Biological", "Mixed", "Biological", "Mixed", "Biological"))



M_t_analyte_withIS.hclust <- M_t_analyte_withIS.hclust %>% 
  left_join(h.clust.factors)
  

carbon_pool <- M_t_analyte_withIS.hclust %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = cluster_factor_types)) +
  geom_col(position = "fill")+
  theme_bw()+
  xlab("")+
  ylab("Mass Fraction")+
  ggtitle("Submicron Sea Spray Aerosol \n Carbon Pool Dynamics")+
  scale_fill_manual(values = cols[1:8])+
  theme(plot.title = element_text(size = 18, hjust = .5), legend.text = element_text(size = 14), legend.title=element_text(size=14), axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16))+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))
  

carbon_pool

carbon_pool2 <- M_t_analyte_withIS.hclust %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = cluster_factor_types.f)) +
  geom_col(position = "fill")+
  theme_bw()+
  xlab("")+
  ylab("Mass Fraction (Recovered)")+
  ggtitle("Submicron Sea Spray Aerosol \n Carbon Pool Dynamics")+
  scale_fill_manual(values = cols2[1:8], name = "")+
  theme(plot.title = element_text(size = 18, hjust = .5), legend.text = element_text(size = 14), legend.title=element_text(size=14), axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16))+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))
  

carbon_pool2

carbon_pool3 <- M_t_analyte_withIS.hclust %>% 
  ggplot(aes(x = r_date, y = amt_ng_per_m3_air, fill = cluster_factor_types.f)) +
  geom_col(position = "fill")+
  theme_bw()+
  xlab("")+
  ylab("Mass Fraction (Recovered)")+
  ggtitle("Submicron Sea Spray Aerosol \n Carbon Pool Dynamics")+
  scale_fill_manual(values = cols2[1:8], name = "")+
  theme(plot.title = element_text(size = 18, hjust = .5), legend.text = element_text(size = 14), legend.title=element_text(size=14), axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16))+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))
  

carbon_pool3

png("carbon_pool4.png", width=6, height=4.5,
    units="in", res=600, pointsize=12)
carbon_pool2
dev.off()

carbon_pool_nodiiso <- M_t_analyte_withIS.hclust %>% 
  filter(Compound.Name != "20200803_1535_blob_745_") %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = cluster_factor_types)) +
  geom_col(position = "fill")+
  theme_bw()+
  xlab("")+
  ylab("Mass Fraction (Recovered)")+
  ggtitle("Submicron Sea Spray Aerosol \n Carbon Pool Dynamics")+
  scale_fill_manual(values = cols[1:8], name = "")+
  theme(plot.title = element_text(size = 18, hjust = .5), legend.text = element_text(size = 14), legend.title=element_text(size=14), axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16))+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))
  


carbon_pool_nodiiso

M_t_analyte_withIS.hclust %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = cluster_factor_types)) +
  scale_fill_manual(values = cols[1:8])+
  geom_col(position = "stack")

cp.si <- M_t_analyte_withIS.hclust %>% 
  ggplot(aes(x = r_date, y = amt_ng_per_m3_air, fill = cluster_factor_types.f)) +
  #scale_fill_manual(values = cols[1:8], name = "")+
  geom_col(position = "stack")+
  theme_bw()+
  xlab("")+
  #ylab("Concentration (ng/m3)")+
  ylab(bquote('Concentration '(ng/m^3)))+
  ggtitle("Submicron Sea Spray Aerosol \n Carbon Pool Dynamics")+
  scale_fill_manual(values = cols2[1:8], name = "")+
  theme(plot.title = element_text(size = 18, hjust = .5), legend.text = element_text(size = 14), legend.title=element_text(size=14), axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), axis.title.y = element_text(size = 16))+
  scale_x_datetime(date_breaks = "6 days", labels = date_format("%b %d"))

png("carbon_pool_forsi.png", width=6, height=4.5,
    units="in", res=600, pointsize=12)
cp.si
dev.off()

M_t_analyte_withIS.hclust %>% 
  filter(Compound.Name != "20200803_1535_blob_745_") %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm, fill = cluster_factor_types)) +
  geom_col(position = "stack")

day.f <- M_t_analyte_withIS.hclust %>% 
  filter(Filter_num == "UCB19_A_153" |Filter_num == "UCB19_A_156" ) %>% 
  filter(!is.na(cluster_group)) %>% 
  group_by(cluster_group) %>% 
  summarise(tot_mass = sum(amt_ng_per_m3_air)) %>% 
  dplyr::mutate(pct_total = .4*tot_mass/sum(day.f$tot_mass))

day.l <- M_t_analyte_withIS.hclust %>% 
  filter(Filter_num == "UCB19_A_196" |Filter_num == "UCB19_A_197" ) %>% 
  filter(!is.na(cluster_group)) %>% 
  group_by(cluster_group) %>% 
  summarise(tot_mass = sum(amt_ng_per_m3_air)) %>% 
  dplyr::mutate(pct_total = .4*tot_mass/sum(day.l$tot_mass))

```

Plotting properties
```{r}
properties <- read_csv("Read_Files/Compiled_Compound_info_SeaScape.prop2_EBF.csv") %>% 
  dplyr::select(Compound.Name, OSc_final, Cnum_final)

Comp_info_prop <- comp_info_cluster_quant %>% 
  left_join(properties)

Comp_info_clust.n <- comp_info_cluster_quant %>% 
  dplyr::select(Compound.Name, cluster_factor_types, cluster_factor_types.f, cluster_group)

Comp_info_prop %>% 
  filter(!is.na(cluster_group)) %>% 
  ggplot(aes(x = Cnum_final, y = OSc_final, color = cluster_factor_types.f))+
  geom_point()+
  facet_grid(cluster_group ~ .) +
  scale_color_manual(values = cols2[1:8], name = "")

day.f.prop <- M_t_analyte_withIS.hclust %>% 
  filter(Filter_num == "UCB19_A_153" |Filter_num == "UCB19_A_156" ) %>% 
  filter(!is.na(cluster_group)) %>% 
  group_by(Compound.Name) %>% 
  summarise(avg_amt_ng_per_m3_air = mean(amt_ng_per_m3_air, na.rm = TRUE)) %>% 
  left_join(properties) %>% 
  left_join(Comp_info_clust.n)

day.l.prop <- M_t_analyte_withIS.hclust %>% 
  filter(Filter_num == "UCB19_A_196" |Filter_num == "UCB19_A_197" ) %>% 
  filter(!is.na(cluster_group)) %>% 
  group_by(Compound.Name) %>% 
  summarise(avg_amt_ng_per_m3_air = mean(amt_ng_per_m3_air, na.rm = TRUE)) %>% 
  left_join(properties)%>% 
  left_join(Comp_info_clust.n)

day.f.prop %>% 
  ggplot(aes(x = Cnum_final, y = OSc_final, 
             color = cluster_factor_types.f, size = (avg_amt_ng_per_m3_air)))+
  geom_point()+
  scale_color_manual(values = cols2[1:8], name = "")+
  scale_size(name = "Concentration\nng/m3", range = c(2, 7))+
  theme_bw(base_size = 14)+
  xlab("Number of Carbons")+
  ylab("OSc")+
  xlim(5, 30)+
  guides(size = FALSE, color = guide_legend(override.aes = list(size=3)))
  # guides(color = guide_legend(order = 1), 
  #             size = guide_legend(order = 2))

prop.l1<- day.l.prop %>% 
  ggplot(aes(x = Cnum_final, y = OSc_final, 
             color = cluster_factor_types.f, size = (avg_amt_ng_per_m3_air)))+
  geom_point()+
  scale_color_manual(values = cols2[1:8], name = "")+
  scale_size(name = "Concentration\nng/m3", range = c(2, 7))+
  theme_bw(base_size = 14)+
  xlab("Number of Carbons")+
  ylab("OSc")+
  xlim(5, 30)+
  guides(size = FALSE, color = guide_legend(override.aes = list(size=3)))  
  #guides(color = guide_legend(order = 1), 
  #            size = guide_legend(order = 2))
  
prop.l1

png("properties_trial1.png", width=7, height=4.5,
    units="in", res=600, pointsize=12)
prop.l1
dev.off()


```

Making a video
```{r}
M_t_analyte_withIS.hclust.prop <- M_t_analyte_withIS.hclust %>% 
  left_join(properties)

bt_sum_bloom3.a <- bt_sum_bloom3 %>% 
  arrange(r_date)

plot_list.ss = list()
for(i in 1:nrow(bt_sum_bloom3)){
  #i = 40
  #i = 39
  date.tt <- bt_sum_bloom3.a$r_date[i]
  
  df.temp <- M_t_analyte_withIS.hclust.prop %>% 
    filter(r_date == date.tt) %>% 
    filter(OSc_final >-500)
  
  prop.t <- df.temp %>% 
    ggplot(aes(x = Cnum_final, y = OSc_final, 
             color = cluster_factor_types.f, size = (amt_ng_per_m3_air)))+
    geom_point()+
    scale_color_manual(values = cols2[1:8], name = "")+
    scale_size(name = "Concentration\nng/m3", range = c(4, 12))+
    theme_bw(base_size = 26)+
    xlab("Number of Carbons")+
    ylab("Carbon Oxidation State")+
    ggtitle(date.tt)+
    xlim(5, 30)+
    ylim(-2.2, .5)+
    guides(size = FALSE, color = guide_legend(override.aes = list(size=6)))  
    
  #prop.t
  #   
  #   
  # #print(iop2.prop.t)
  # 
  # grouped.clust.ss.2 <- M_t_analyte_withIS.hclust.prop %>% 
  #   group_by(r_date, cluster_factor_types.f) %>% 
  #   summarise(ug_per_m3_air = sum(ug_per_m3_air, na.rm = TRUE)) %>% 
  #   left_join(iop2.scale) %>% 
  #   filter(r_date > bt_sum_iop2.a$r_date[s.i.iop2]) %>% 
  #   filter(r_date < bt_sum_iop2.a$r_date[e.i.iop2]) %>% 
  #   mutate(ug_per_m3_air.s = ug_per_m3_air/ scale.s)
  # 
  # grouped.clust.tl.2.t <- grouped.clust.tl.2 %>% 
  #   filter(r_date == date.tt)
  # 
  # 
  # 
  # iop2.tl.t <- grouped.clust.tl.2%>% 
  #   ggplot(aes(x = r_date, y = ug_per_m3_air.s, 
  #            color = as.factor(cluster_group)))+
  #   geom_line(size = 2)+
  #   geom_point(data = grouped.clust.tl.2.t, aes(x = r_date, y = ug_per_m3_air.s, 
  #                                               shape = cluster_group), 
  #              color = "black", size = 4)+
  #   scale_color_manual(name = "Event Influence\nClusters", values = c("green3", "orange", "grey35"), labels = c("Background/Biogenic", "Biomass Burning\n(/5)",
  #                                      "Urban Plume"))+
  #   ylab("Organic Mass (ug/m3)")+
  #   xlab("")+
  #   ggtitle("  ")+
  #   guides(shape = FALSE)+
  #   theme_bw(base_size = 20)
  # 
  # iop2.multi.t <- ggarrange(iop2.prop.t, iop2.tl.t, heights = c(8, 5), 
  #         labels = c("A", "B"), nrow = 2, ncol = 1)
  # 
  # print(iop2.multi.t)
  
  plot_list.ss[[i]] = prop.t
  
  
}

for(i in 1:length(plot_list.ss)){
  tt.name.t <- paste("Write_Files/Properties_Video/c", i,".png", sep = "")
  
  png(tt.name.t, width=16, height=9,
    units="in", res=500, pointsize=2)
    print(plot_list.ss[[i]])
  dev.off() 
  
}
```

Video attempt 2 only samples that correspond to HB and chlor obs

```{r}
chla_hb.a <- chla_hb %>% 
  arrange(r_date)

plot_list.ss.a = list()
for(i in 1:nrow(chla_hb.a)){
  #i = 40
  #i = 39
  #i = 5
  date.tt <- chla_hb.a$r_date[i]
  
  df.temp <- M_t_analyte_withIS.hclust.prop %>% 
    filter(r_date == date.tt) %>% 
    filter(OSc_final >-500)
  
  prop.t <- df.temp %>% 
    ggplot(aes(x = Cnum_final, y = OSc_final, 
             color = cluster_factor_types.f, size = (amt_ng_per_m3_air)))+
    geom_point()+
    scale_color_manual(values = cols2[1:8], name = "Cluster")+
    scale_size(name = "Concentration\nng/m3", range = c(3, 11))+
    theme_bw(base_size = 22)+
    xlab("Number of Carbons")+
    ylab("Carbon Oxidation State")+
    #ggtitle(date.tt)+
    ggtitle(paste("Submicron SSA Organic Composition\n", date.tt, sep = ""))+
    #ggtitle("Submicron SSA Organic Composition")
    xlim(5, 30)+
    ylim(-2.2, .5)+
    guides(size = FALSE, color = guide_legend(override.aes = list(size=6)))  
    
  prop.t


  #print(iop2.prop.t)

  # grouped.clust.ss.2 <- M_t_analyte_withIS.hclust.prop %>%
  #   group_by(r_date, cluster_factor_types.f) %>%
  #   summarise(ug_per_m3_air = sum(ug_per_m3_air, na.rm = TRUE)) %>%
  #   left_join(iop2.scale) %>%
  #   filter(r_date > bt_sum_iop2.a$r_date[s.i.iop2]) %>%
  #   filter(r_date < bt_sum_iop2.a$r_date[e.i.iop2]) %>%
  #   mutate(ug_per_m3_air.s = ug_per_m3_air/ scale.s)
  # 
  # grouped.clust.tl.2.t <- grouped.clust.tl.2 %>%
  #   filter(r_date == date.tt)
  chlahb_tp <- chla_hb.a %>% 
    filter(r_date == date.tt)
  



  chla_hb.t <- chla_hb%>%
    ggplot(aes(x = r_date, y = chla_norm, color = "A"))+
    geom_line(size = 2)+
    geom_line(aes(x = r_date, y = hb_norm, color = "B"), size = 2)+
    geom_point(data = chlahb_tp, aes(x = r_date, y = chla_norm),
               color = "green4", size = 6)+
    geom_point(data = chlahb_tp, aes(x = r_date, y = hb_norm),
               color = "blue3", size = 6)+
    scale_color_manual(name = "Bloom\nIndicator", values = c("green3", "blue2"),
                       labels = c("Chlorophyll-a", "Heterotrophic\nBacteria"))+
    ylab("Normalized\nConcentration")+
    xlab("")+
    #ggtitle("  ")+
    guides(shape = FALSE)+
    theme_bw(base_size = 22)
  
  chla_hb.t

  prop.multi.t <- ggarrange(prop.t, chla_hb.t, heights = c(8, 3.5),
          labels = c("A", "B"), nrow = 2, ncol = 1, align = "v")

  print(prop.multi.t)
  
  prop.multi.t
  
  plot_list.ss.a[[i]] = prop.multi.t
  
  
}




# png("properties_2panel.png", width=10, height=10,
#     units="in", res=600, pointsize=12)
# prop.multi.t
# dev.off()


for(i in 1:length(plot_list.ss.a)){
  tt.name.t <- paste("Write_Files/Properties_Video2/d", i,".png", sep = "")
  
  png(tt.name.t, width=14, height=10,
    units="in", res=500, pointsize=2)
    print(plot_list.ss.a[[i]])
  dev.off() 
  
}
```



```{r}
first_day.p <- M_t_analyte_withIS.hclust.prop %>% 
  filter(Filter_num == "UCB19_A_153") %>% 
  
    ggplot(aes(x = Cnum_final, y = OSc_final, 
             color = cluster_factor_types.f, size = (amt_ng_per_m3_air)))+
    geom_point()+
    scale_color_manual(values = cols2[1:8], name = "")+
    #scale_size(name = bquote('Concentration '(ng/m^3)), range = c(4, 12))+
    scale_size(name = "Concentration\nng/m3", range = c(1.5, 7))+
    theme_bw(base_size = 14)+
    xlab("Number of Carbons")+
    ylab("Carbon Oxidation State")+
    ggtitle("First Day")+
    xlim(5, 33)+
    ylim(-2.2, .5)+
    guides(size = FALSE, color = guide_legend(override.aes = list(size=3))) 
    
first_day.p

last_day.p <- M_t_analyte_withIS.hclust.prop %>% 
  filter(Filter_num == "UCB19_A_196") %>% 
  
    ggplot(aes(x = Cnum_final, y = OSc_final, 
             color = cluster_factor_types.f, size = (amt_ng_per_m3_air)))+
    geom_point()+
    scale_color_manual(values = cols2[1:8], name = "")+
    #scale_size(name = bquote('Concentration '(ng/m^3)), range = c(4, 12))+
    scale_size(name = "Concentration\nng/m3", range = c(1.5, 7))+
    theme_bw(base_size = 14)+
    xlab("Number of Carbons")+
    ylab("Carbon Oxidation State")+
    ggtitle("Last Day")+
    xlim(5, 33)+
    ylim(-2.2, .5)+
    guides(size = FALSE, color = guide_legend(override.aes = list(size=3))) 
    
last_day.p

mid_day.p <- M_t_analyte_withIS.hclust.prop %>% 
  filter(Filter_num == "UCB19_A_181") %>% 
  
    ggplot(aes(x = Cnum_final, y = OSc_final, 
             color = cluster_factor_types.f, size = (amt_ng_per_m3_air)))+
    geom_point()+
    scale_color_manual(values = cols2[1:8], name = "")+
    #scale_size(name = bquote('Concentration '(ng/m^3)), range = c(4, 12))+
    scale_size(name = "Concentration\nng/m3", range = c(1.5, 7))+
    theme_bw(base_size = 14)+
    xlab("Number of Carbons")+
    ylab("Carbon Oxidation State")+
    ggtitle("Mid Bloom")+
    xlim(5, 33)+
    ylim(-2.2, .5)+
    guides(size = FALSE, color = guide_legend(override.aes = list(size=3))) 
    
mid_day.p

prop.tiles <- ggarrange(first_day.p, mid_day.p, last_day.p, heights = c(3, 3, 3), 
          labels = c("A", "B", "C"),
          ncol = 1, nrow = 3, align = "v")

prop.tiles

png("proptiles.png", width=7, height=10,
    units="in", res=600, pointsize=12)
prop.tiles
dev.off()



```


Benzoic acid traces
```{r}

ba.check <- M_t_analyte_withIS.hclust %>% 
  filter(Compound.Name == "20200803_0949_blob_1273_"| 
           Compound.Name == "20200803_0949_blob_900_"|
           Compound.Name == "20200803_0949_blob_981_") 

ba.check %>% 
  ggplot(aes(x = r_date, y = amt_ng_per_m3_air, color = cluster_factor_types))+
  geom_line()

ba.check2 <- M_t_analyte_withIS.hclust %>% 
  filter(Compound.Name == "20200803_0949_blob_1273_"| 
           Compound.Name == "20200803_0949_blob_900_"|
           Compound.Name == "20200803_0949_blob_981_") %>% 
  group_by(r_date) %>% 
  summarise(tot_mass = sum(amt_ng_per_m3_air))

ba.check2 %>% 
  ggplot(aes(x = r_date, y = tot_mass))+
  geom_line()

```


Plotting mass spectra of interesting unknown biogenic compounds
```{r}
unkbio_MS_o = read_csv(file = "Read_Files/Unk_bio_MS.csv")

trim.leading <- function (x)  sub("^\\s+", "", x)

unkbio_MS_t = unkbio_MS_o %>% 
    dplyr::mutate(MS = strsplit(as.character(MS), ";")) %>% 
    unnest(MS) %>% 
    filter(MS != "") %>% 
    dplyr::mutate(MS2 = trim.leading(MS)) 
  



unkbio_MS_3 = separate(data = unkbio_MS_t, col = MS2, into = c("mz", "intensity"), sep = " ")

unkbio_MS_full = unkbio_MS_3 %>% 
  dplyr::mutate(intensity = as.numeric(intensity)) %>% 
  dplyr::mutate(mz = as.numeric(mz)) %>% 
  arrange(desc(intensity)) %>% 
  arrange(desc(Name)) %>% 
  group_by(Name) %>%
  dplyr::mutate(my_ranks = order(order(intensity, decreasing=TRUE))) %>% 
  ungroup()

bio_ms_1 <- unkbio_MS_full %>% 
  filter(Name == "20200803_1535_blob_745_") 

bio_ms_1.p <- bio_ms_1 %>% 
  ggplot(aes(x = mz, y = intensity))+
  geom_col(width = .5, fill = "black")+
  geom_text(aes(label=ifelse(my_ranks<6,as.character(mz),'')),hjust=0,vjust=0)+
  xlab("m/z")+
  ylab("Intensity")+
  theme_bw(base_size = 14)

png("Biounk_1_ms.png", width=6.5, height=4,
    units="in", res=600, pointsize=12)
bio_ms_1.p
dev.off()

bio_ms_2 <- unkbio_MS_full %>% 
  filter(Name == "20200803_1535_blob_21_") 

library(ggrepel)

bio_ms_2.p <- bio_ms_2 %>% 
  ggplot(aes(x = mz, y = intensity))+
  geom_col(width = .5, fill = "black")+
  geom_text(aes(label=ifelse(my_ranks<5,as.character(mz),'')),hjust=-.2,vjust=0)+
  #geom_label_repel(aes(label = ifelse(my_ranks<5,as.character(mz),'')), 
   #                label.size = NA)+
                  #box.padding   = 0.35, 
                  #point.padding = 0.5,
                  #segment.color = 'grey50') +
  xlab("m/z")+
  ylab("Intensity")+
  theme_bw(base_size = 14)

bio_ms_2.p

png("Biounk_2_ms.png", width=6.5, height=4,
    units="in", res=600, pointsize=12)
bio_ms_2.p
dev.off()

```





```{r}
#BTZ check
M_t_analyte_withIS.hclust %>% 
  filter(Compound.Name == "20200803_1535_blob_958_") %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm))+
  geom_point()

M_t_analyte_withIS.q %>% 
  filter(Compound.Name == "20200803_1535_blob_958_") %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm))+
  geom_point()

M_t_analyte_withIS.q %>% 
  filter(Compound.Name == "20200803_1535_blob_958_") %>% 
  ggplot(aes(x = r_date, y = vol_is_normnorm_ptnorm))+
  geom_point()

M_t_analyte_withIS.q %>% 
  filter(Compound.Name == "20200803_1535_blob_958_") %>% 
  ggplot(aes(x = r_date, y = vol_is_rawnorm_ptnorm))+
  geom_point()

M_t_analyte_withIS_smoothed %>% 
  filter(Compound.Name == "20200803_1535_blob_958_") %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm_smooth))+
  geom_point()



cluster_corr_hclust.5 <- cluster_corr_hclust %>% 
  filter(best_corr == "F5") %>% 
  left_join(compiled_comp_info)

# diiso check

diiso_check <- M_t_analyte_withIS.q %>% 
  filter(Compound.Name == "20200803_1535_blob_745_")

diiso_check %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm))+
  geom_line()

diiso_check %>% 
  ggplot(aes(x = r_date, y = vol_is_normnorm_ptnorm))+
  geom_line()

diiso_check %>% 
  ggplot(aes(x = r_date, y = vol_is_rawnorm_ptnorm))+
  geom_line()

diiso_check %>% 
  ggplot(aes(x = r_date, y = IS_mean_norm))+
  geom_line()

diiso_check %>% 
  ggplot(aes(x = r_date, y = Volume))+
  geom_line()
```
Inspecting the unclustered compounds
```{r}

unclustered <- M_t_analyte_withIS.hclust %>% 
  filter(is.na(cluster_factor_types)) %>% 
  left_join(SeaScape_normalized_cumsum.q) %>% 
  arrange(desc(quant_pct))

table(unclustered$Compound.Name)


write.csv(unclustered, "inspect_unclustered.csv")
```


What is actually in each cluster
```{r}

c1_bio1 <- cluster_assignments %>% 
  filter(cluster_assigned == 1) %>% 
  left_join(Analyte_positions) %>% 
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

c2_anthro1 <- cluster_assignments %>% 
  filter(cluster_assigned == 2) %>%   
  left_join(Analyte_positions) %>% 
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

c3 <- cluster_assignments %>% 
  filter(cluster_assigned == 3) %>%
  left_join(Analyte_positions) %>%
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

c4 <- cluster_assignments %>% 
  filter(cluster_assigned == 4) %>% 
  left_join(Analyte_positions) %>%
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

c5_mixed_interesting <- cluster_assignments %>% 
  filter(cluster_assigned == 5) %>% 
  left_join(Analyte_positions) %>%
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

c6_anthro2 <- cluster_assignments %>% 
  filter(cluster_assigned == 6) %>% 
  left_join(Analyte_positions) %>%
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

c7 <- cluster_assignments %>% 
  filter(cluster_assigned == 7) %>% 
  left_join(Analyte_positions) %>%
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

c8 <- cluster_assignments %>% 
  filter(cluster_assigned == 8) %>% 
  left_join(Analyte_positions) %>%
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

call <- cluster_assignments %>% 
  left_join(h.clust.factors) %>% 
  left_join(Analyte_positions) %>%
  left_join(compiled_comp_info) %>% 
  left_join(SeaScape_normalized_cumsum.q)

call %>% 
  ggplot(aes(x = LRI.I, y = RI2, color = as.factor(cluster_factor_types)))+
  geom_point()

c1_bio1 %>% 
  ggplot(aes(x = quantcumsum, y = Library.Match.Factor_NISTmain))+
  geom_point()

c2_anthro1 %>% 
  ggplot(aes(x = quantcumsum, y = Library.Match.Factor_NISTmain))+
  geom_point()


```




```{r}
for(i in 1:nrow(cluster_corr_hclust.5)){
  cc <- cluster_corr_hclust.5$Compound.Name[i]
  
  fff <- M_t_analyte_withIS.q %>% 
    filter(Compound.Name == cc) %>% 
    ggplot(aes(x = r_date, y = amt_ng_ptnorm, color = Compound.Name))+
    geom_line()
  
  print(fff)
  
}


```


```{r}

summary(SeaScape_normalized_cumsum$isnormnormptnorm_cumsum)

M_t_analyte_withIS.hclust %>% 
  left_join(compiled_comp_info, by = "Compound.Name") %>% 
  left_join(SeaScape_normalized_cumsum) %>% 
  left_join(h.clust.factors) %>% 
  filter(isnormnormptnorm_cumsum > 8562) %>% 
  ggplot(aes(x = cluster_factors, y = Library.Match.Factor_NISTmain, fill = cluster_factors))+
  geom_violin()

ttt <- M_t_analyte_withIS.hclust %>% 
  left_join(compiled_comp_info, by = "Compound.Name") %>% 
  left_join(SeaScape_normalized_cumsum_cumulative) %>% 
  left_join(h.clust.factors) %>% 
  filter(isnormnorm_ptnorm_pct_cumulative < .9) %>% 
  group_by(Compound.Name, cluster_factors) %>% 
  summarise(la = 1)

table(ttt$cluster_factors)

M_t_analyte_withIS.hclust %>% 
  left_join(compiled_comp_info, by = "Compound.Name") %>% 
  left_join(SeaScape_normalized_cumsum_cumulative) %>% 
  left_join(h.clust.factors) %>% 
  filter(isnormnorm_ptnorm_pct_cumulative < .9) %>% 
  ggplot(aes(x = cluster_factors, y = Library.Match.Factor_NISTmain, fill = cluster_factors))+
  geom_boxplot()+
  theme_bw()+
  ylab("NIST Mass Spectral\nMatch Factor")+
  xlab("")+
  theme(axis.text.x = element_text(size = 16, angle = -45, vjust = .2, hjust = .5), axis.text.y = element_text(size = 16), axis.title.y = element_text(size = 18))

library("DescTools")

NIST_summaries.hclust <- M_t_analyte_withIS.hclust %>% 
  left_join(compiled_comp_info, by = "Compound.Name") %>% 
  left_join(SeaScape_normalized_cumsum_cumulative) %>% 
  left_join(h.clust.factors) %>% 
  filter(isnormnorm_ptnorm_pct_cumulative < .9) %>% 
  mutate(rounded_nist= RoundTo(Library.Match.Factor_NISTmain, 10)) %>% 
  group_by(rounded_nist, cluster_factors) %>% 
  summarise(nist_normalized_signal_pct = sum(isnormnormptnorm_pct))

cumulative_signal_byfactor <- NIST_summaries.hclust %>% 
  group_by(cluster_factors) %>% 
  summarise(total_factor_signal = sum(nist_normalized_signal_pct))

NIST_summaries.hclust <- NIST_summaries.hclust %>% 
  left_join(cumulative_signal_byfactor) %>% 
  mutate(normalized_nistbinned_signal = nist_normalized_signal_pct / total_factor_signal)

NIST_summaries.hclust %>% 
  ggplot(aes(x = rounded_nist, y = nist_normalized_signal_pct, fill = cluster_factors))+
  geom_col()

# M_t_analyte_withIS.hclust %>% 
#   left_join(compiled_comp_info, by = "Compound.Name") %>% 
#   left_join(SeaScape_normalized_cumsum_cumulative) %>% 
#   left_join(h.clust.factors) %>% 
#   filter(isnormnorm_ptnorm_pct_cumulative < .9) %>% 
#   mutate(rounded_nist= RoundTo(Library.Match.Factor_NISTmain, 25))
#   ggplot(aes(x = log(isnormnormptnorm_pct), y = Library.Match.Factor_NISTmain, color = cluster_factors))+
#   geom_point()

M_t_analyte_withIS.hclust %>% 
  left_join(compiled_comp_info, by = "Compound.Name") %>% 
  ggplot(aes(x = cluster_combined, y = LRI.I.x, fill = cluster_combined))+
  geom_violin()

M_t_analyte_withIS.hclust %>% 
  left_join(compiled_comp_info, by = "Compound.Name") %>% 
  left_join(SeaScape_normalized_cumsum) %>% 
  ggplot(aes(x = cluster_combined, y = LRI.I.x, fill = cluster_combined))+
  geom_violin()

# personal care products
M_t_analyte_withIS.hclust.1 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 1)

# early perturbed- possibly bio related, spiky
M_t_analyte_withIS.hclust.2 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 2)

# possibly bio related decreases then increasesan
M_t_analyte_withIS.hclust.3 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 3)

# anthro biodegrades- oil typical
M_t_analyte_withIS.hclust.4 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 4)

# lots of s containing things- interesting
M_t_analyte_withIS.hclust.5 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 5)


#biolog accumulating- breakdown products
M_t_analyte_withIS.hclust.6 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 6)

# biogenic things
M_t_analyte_withIS.hclust.7 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 7)

# more biogenic things
M_t_analyte_withIS.hclust.8 <- M_t_analyte_withIS.hclust %>%
  left_join(compiled_comp_info, by = "Compound.Name") %>%
  filter(cluster_combined == 8)



```


```{r}

clusters_compID <- cluster_corr_infor %>% 
  mutate(cluster_combined = ifelse(is.na(cluster), sub('.', '', best_corr), cluster)) %>% 
  left_join(h.clust.factors) %>% 
  left_join(SeaScape_normalized_cumsum)

# personal care products, homosalate important
clustersAid <- clusters_compID %>% 
  filter(cluster_factors== "Factor A") %>% 
  arrange(desc(isnormnormptnorm_cumsum))

# dimethylheptadecane, oils
clustersBid <- clusters_compID %>% 
  filter(cluster_factors== "Factor B") %>% 
  arrange(desc(isnormnormptnorm_cumsum))

# palmitic acid, maybe contamination
clustersCid <- clusters_compID %>% 
  filter(cluster_factors== "Factor C") %>% 
  arrange(desc(isnormnormptnorm_cumsum))

# definitely a mix of things
clustersDid <- clusters_compID %>% 
  filter(cluster_factors== "Factor D") %>% 
  arrange(desc(isnormnormptnorm_cumsum))

# total mystery but theres not much of it so qho cares
clustersEid <- clusters_compID %>% 
  filter(cluster_factors== "Factor E") %>% 
  arrange(desc(isnormnormptnorm_cumsum))



# a lot of this looks antho tbh, but gonna focus on 	Cyclooctasiloxane, hexadecamethyl-, which is reported in marine cyanobacteria and looks biogenic from time series
clustersFid <- clusters_compID %>% 
  filter(cluster_factors== "Factor F") %>% 
  arrange(desc(isnormnormptnorm_cumsum))

M_t_analyte_withIS_smoothed %>% 
  filter(Compound.Name == "20200803_1535_blob_453_") %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm_smooth))+
  geom_line()

M_t_analyte_withIS_smoothed %>% 
  filter(Compound.Name == "20200803_1535_blob_23_fb") %>% 
  ggplot(aes(x = r_date, y = amt_ng_ptnorm_smooth))+
  geom_line()

M_t_analyte_withIS_smoothed %>% 
  filter(Compound.Name == "20200803_0949_blob_786_") %>% 
  ggplot(aes(x = r_date, y = vol_is_normnorm_ptnorm_smooth))+
  geom_line()

# dimethyl quinoline and trimethyl quinoline, previously reported intercellylar algae components
clustersGid <- clusters_compID %>% 
  filter(cluster_factors== "Factor G") %>% 
  arrange(desc(isnormnormptnorm_cumsum))

# alcohol components of previously reported macroalgae
# also linalool oxide, reported in red algae
clustersHid <- clusters_compID %>% 
  filter(cluster_factors== "Factor H") %>% 
  arrange(desc(isnormnormptnorm_cumsum))

M_t_analyte_withIS_smoothed %>% 
  filter(Compound.Name == "20200803_0949_blob_715_oil") %>% 
  ggplot(aes(x = r_date, y = vol_is_normnorm_ptnorm_smooth))+
  geom_line()




```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
